<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLE BLACKBOX RECORDER</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 10px; overflow: hidden; }
        
        /* Kontrollzentrum - Muss groß sein für Staplerfahrer */
        #controls { position: fixed; top: 0; left: 0; right: 0; background: #111; padding: 10px; border-bottom: 2px solid #0f0; z-index: 100; }
        button { width: 48%; height: 50px; font-weight:bold; font-size: 1rem; border: 1px solid #0f0; background: #000; color: #0f0; }
        button.stop { border-color: #f00; color: #f00; }
        button.download { background: #004400; color: #fff; width: 100%; margin-top: 5px; }

        /* Statusanzeige */
        #stats { margin-top: 110px; font-size: 0.9rem; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px;}
        .stat-box { display: inline-block; width: 48%; }
        .highlight { color: #fff; font-weight: bold; }

        /* Der Live-Log */
        #logWindow { 
            height: calc(100vh - 160px); 
            overflow-y: scroll; 
            font-size: 0.75rem; 
            margin-top: 10px;
            white-space: pre-wrap; /* Wichtig für Hex-Umbruch */
        }
        .entry { border-bottom: 1px solid #222; padding: 4px 0; }
        .rssi-bad { color: #555; }
        .rssi-good { color: #0f0; }
        .rssi-hot { color: #ff00ff; font-weight: bold; } /* Wenn du direkt davor stehst */
    </style>
</head>
<body>

    <div id="controls">
        <div style="display:flex; justify-content:space-between;">
            <button id="btnStart" onclick="startScan()">REC START</button>
            <button class="stop" onclick="stopScan()">STOP</button>
        </div>
        <button class="download" onclick="downloadCSV()">CSV EXPORTIEREN (EXCEL)</button>
    </div>

    <div id="stats">
        <div class="stat-box">Pakete: <span id="pkgCount" class="highlight">0</span></div>
        <div class="stat-box">Geräte: <span id="devCount" class="highlight">0</span></div>
        <div id="statusMsg">Warte auf Start...</div>
    </div>

    <div id="logWindow"></div>

    <script>
        let scanResult;
        let isScanning = false;
        
        // Der Hauptspeicher - Hier landen ALLE Daten
        let database = []; // Array von Objekten
        let uniqueDevices = new Set();
        let packageCounter = 0;

        // Hilfsfunktion: Bytes zu Hex-String
        function buf2hex(buffer) {
            return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('').toUpperCase();
        }

        function updateStats() {
            document.getElementById('pkgCount').innerText = packageCounter;
            document.getElementById('devCount').innerText = uniqueDevices.size;
        }

        function logToScreen(mac, rssi, name, hexData) {
            const logWin = document.getElementById('logWindow');
            
            // Performance-Schutz: Zeige nur die letzten 50 Einträge im Browser an,
            // aber speichere ALLES im Hintergrund.
            if (logWin.children.length > 50) {
                logWin.lastElementChild.remove();
            }

            // Farbcodierung nach Signalstärke
            let colorClass = 'rssi-bad';
            if (rssi > -80) colorClass = 'rssi-good';
            if (rssi > -60) colorClass = 'rssi-hot';

            const div = document.createElement('div');
            div.className = 'entry';
            div.innerHTML = `
                <span class="${colorClass}">[${rssi}]</span> ${mac} | ${name} <br>
                <span style="color:#666; font-size:0.7em">${hexData}</span>
            `;
            logWin.prepend(div);
        }

        async function startScan() {
            if (isScanning) return;
            
            // Reset bei Neustart? Nein, wir hängen an (Continuous Logging).
            // Falls Reset gewünscht: database = []; packageCounter = 0;
            
            try {
                scanResult = await navigator.bluetooth.requestLEScan({
                    acceptAllAdvertisements: true,
                    keepRepeatedDevices: true // WICHTIG: Sonst gibt's nur 1 Paket pro MAC
                });

                isScanning = true;
                document.getElementById('statusMsg').innerText = "AUFNAHME LÄUFT - NICHT SCHLIESSEN!";
                document.getElementById('btnStart').style.background = "#0f0";
                document.getElementById('btnStart').style.color = "#000";

                navigator.bluetooth.addEventListener('advertisementreceived', event => {
                    packageCounter++;
                    
                    const mac = event.device.id;
                    const rssi = event.rssi;
                    const name = event.device.name || "N/A";
                    const timestamp = new Date().toISOString();
                    
                    uniqueDevices.add(mac);

                    // --- DATEN EXTRAKTION ---
                    let rawPayload = "";
                    let parsedData = ""; // Für CSV: CID/UUID getrennt

                    // 1. Manufacturer Data
                    event.manufacturerData.forEach((value, key) => {
                        const hexVal = buf2hex(value.buffer);
                        const cid = key.toString(16).padStart(4, '0').toUpperCase();
                        rawPayload += `[M:${cid}=${hexVal}] `;
                        parsedData += `MAN_ID:${cid}|DATA:${hexVal};`;
                    });

                    // 2. Service Data (Wichtig für FTS!)
                    if (event.serviceData) {
                        event.serviceData.forEach((value, key) => {
                            const hexVal = buf2hex(value.buffer);
                            rawPayload += `[S:${key}=${hexVal}] `;
                            parsedData += `SVC_UUID:${key}|DATA:${hexVal};`;
                        });
                    }

                    // 3. UUIDs (Liste der Services)
                    let uuidStr = "";
                    if (event.uuids) {
                        uuidStr = event.uuids.join(',');
                        rawPayload += `[U:${uuidStr}]`;
                    }

                    // --- SPEICHERN ---
                    // Wir speichern ein strukturiertes Objekt für den CSV Export
                    database.push({
                        time: timestamp,
                        rssi: rssi,
                        mac: mac, // Browser ID
                        name: name,
                        uuids: uuidStr,
                        raw_combined: parsedData || "EMPTY_PAYLOAD",
                        txPower: event.txPower || ""
                    });

                    // --- UI UPDATE (Throttled für Performance) ---
                    if (packageCounter % 5 === 0) { // Nur jedes 5. Paket rendern um CPU zu sparen
                        updateStats();
                        // Nur anzeigen wenn Payload da ist oder RSSI stark ist
                        if (rawPayload.length > 5 || rssi > -70) {
                            logToScreen(mac, rssi, name, rawPayload);
                        }
                    }
                });

            } catch (error) {
                alert("Fehler: " + error + "\nBluetooth aktiv? Flags an?");
            }
        }

        function stopScan() {
            if (scanResult) {
                scanResult.stop();
                isScanning = false;
                document.getElementById('statusMsg').innerText = "GESTOPPT. CSV DOWNLOADEN!";
                document.getElementById('btnStart').style.background = "#000";
                document.getElementById('btnStart').style.color = "#0f0";
            }
        }

        function downloadCSV() {
            if (database.length === 0) {
                alert("Keine Daten aufgenommen!");
                return;
            }

            // CSV Header
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Timestamp,RSSI,MAC_ID,Name,UUIDs,Payload_Hex,TxPower\n";

            // Daten Zeile für Zeile
            database.forEach(row => {
                let cleanPayload = row.raw_combined.replace(/,/g, ";"); // Kommas im Payload killen CSV Struktur
                let rowStr = `${row.time},${row.rssi},${row.mac},"${row.name}","${row.uuids}",${cleanPayload},${row.txPower}`;
                csvContent += rowStr + "\n";
            });

            // Download Trigger
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const filename = "FTS_SCAN_" + new Date().toISOString().slice(0,19).replace(/:/g,"-") + ".csv";
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
