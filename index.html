<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BLE RAW MONITOR</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #000; color: #0f0; margin: 0; padding: 10px; }
        button { width: 48%; padding: 15px; font-weight:bold; font-size: 1rem; border: 1px solid #0f0; background: #000; color: #0f0; margin-bottom: 10px; }
        button.stop { border-color: #f00; color: #f00; }
        #log { margin-top: 10px; font-size: 0.75rem; word-break: break-all; }
        .entry { border-bottom: 1px solid #333; padding: 5px 0; }
        .entry.strong { color: #fff; background: #222; } /* Starkes Signal */
        .raw { color: #aaa; }
        .uuid { color: #ff00ff; }
        .info { color: #0ff; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between;">
        <button onclick="startScan()">SCAN START</button>
        <button class="stop" onclick="stopScan()">STOP / FREEZE</button>
    </div>
    
    <div id="status">Warte auf Start...</div>
    <div id="log"></div>

    <script>
        let scanResult;
        let isScanning = false;

        function logToScreen(mac, rssi, name, uuids, manDataHex) {
            const logDiv = document.getElementById('log');
            
            // Highlight starke Signale (>-60dBm) -> Das sind die Geräte direkt neben dir!
            const isStrong = rssi > -60;
            const styleClass = isStrong ? 'entry strong' : 'entry';

            const html = `
                <div class="${styleClass}">
                    <span class="info">RSSI: ${rssi}</span> | ID: ${mac} <br>
                    Name: ${name || "N/A"} <br>
                    <span class="uuid">UUIDs: ${uuids}</span> <br>
                    <span class="raw">Hex: ${manDataHex}</span>
                </div>
            `;
            
            // Einfügen am Anfang
            logDiv.insertAdjacentHTML('afterbegin', html);

            // Liste sauber halten (Max 50 Einträge, sonst crasht der Browser bei Flood)
            if (logDiv.children.length > 50) {
                logDiv.lastElementChild.remove();
            }
        }

        async function startScan() {
            if (isScanning) return;
            document.getElementById('log').innerHTML = ""; // Clear
            
            try {
                // ALLES zulassen. Keine Filter.
                scanResult = await navigator.bluetooth.requestLEScan({
                    acceptAllAdvertisements: true,
                    keepRepeatedDevices: true
                });

                isScanning = true;
                document.getElementById('status').innerText = "SCAN LÄUFT - RAW MODE";

                navigator.bluetooth.addEventListener('advertisementreceived', event => {
                    // Daten aufbereiten
                    const mac = event.device.id; // Browser ID
                    const rssi = event.rssi;
                    const name = event.device.name;
                    
                    // UUIDs sammeln
                    let uuids = [];
                    if (event.uuids) uuids = event.uuids.map(u => u.split('-')[0]); // Nur der Anfang der UUID

                    // Manufacturer Data zu Hex String konvertieren
                    let hexStr = "";
                    event.manufacturerData.forEach((value, key) => {
                        // Key ist die Company ID (z.B. 89 für 0x0059)
                        let companyIdHex = key.toString(16).padStart(4, '0'); 
                        hexStr += `[CID:${companyIdHex}] `; // Zeige Company ID explizit an
                        
                        for (let i = 0; i < value.byteLength; i++) {
                            hexStr += value.getUint8(i).toString(16).padStart(2, '0');
                        }
                        hexStr += " ";
                    });

                    logToScreen(mac, rssi, name, uuids.join(', '), hexStr);
                });

            } catch (error) {
                alert("Fehler: " + error);
            }
        }

        function stopScan() {
            if (scanResult) {
                scanResult.stop();
                isScanning = false;
                document.getElementById('status').innerText = "GESTOPPT (Liste eingefroren)";
            }
        }
    </script>
</body>
</html>
 
