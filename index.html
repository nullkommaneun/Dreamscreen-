<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTS Ghost Hunter</title>
    <style>
        body { font-family: monospace; background: #121212; color: #00ff00; padding: 10px; }
        h2 { border-bottom: 1px solid #444; }
        button { width: 100%; padding: 15px; background: #333; color: white; border: 1px solid #00ff00; font-size: 1.2em; margin-bottom: 10px; cursor: pointer; }
        button.stop { background: #500; border-color: red; }
        .device { border: 1px solid #333; padding: 10px; margin-bottom: 5px; background: #1a1a1a; }
        .rssi-bar { height: 5px; background: #444; margin-top: 5px; }
        .rssi-val { height: 100%; background: #00ff00; transition: width 0.1s; }
        .log { font-size: 0.8em; color: #888; height: 100px; overflow-y: scroll; border-top: 1px solid #333; margin-top: 20px;}
        .highlight { color: #ff00ff; font-weight: bold; }
    </style>
</head>
<body>

    <h2>FTS GHOST HUNTER</h2>
    <div id="status">Bereit. (Flags aktiviert?)</div>
    
    <button onclick="startScan()">SCAN STARTEN</button>
    <button class="stop" onclick="stopScan()">STOPP</button>

    <h3>Gefundene Ziele (Filter aktiv)</h3>
    <div id="results"></div>

    <div class="log" id="consoleLog"></div>

    <script>
        let scanResult;
        const TARGET_COMPANY_ID = 0x0059; // Nordic Semiconductor
        const TARGET_SERVICE_UUID = "00001523-1212-efde-1523-785feabcd123"; // Aus deiner CBOR Analyse
        const SHORT_UUID = "1523";

        // Speicher für Geräte, gruppiert nach Payload (nicht MAC!)
        const ghosts = {};

        function log(msg) {
            const el = document.getElementById('consoleLog');
            el.innerHTML = `> ${msg}<br>` + el.innerHTML;
        }

        async function startScan() {
            if (!navigator.bluetooth) {
                alert("Web Bluetooth nicht verfügbar! Nutze Chrome auf Android & HTTPS.");
                return;
            }

            try {
                log("Fordere Scan an...");
                
                // Wir nutzen acceptAllAdvertisements, um ALLES zu sehen und filtern manuell.
                // Das umgeht Bugs in den nativen Filtern.
                scanResult = await navigator.bluetooth.requestLEScan({
                    acceptAllAdvertisements: true, 
                    keepRepeatedDevices: true // WICHTIG für RSSI Updates!
                });

                log("Scan läuft! Warte auf Pakete...");
                document.getElementById('status').innerText = "SCAN LÄUFT... BEWEG DICH!";

                navigator.bluetooth.addEventListener('advertisementreceived', event => {
                    handlePacket(event);
                });

            } catch (error) {
                log("FEHLER: " + error);
                alert("Scan fehlgeschlagen. Hast du 'Experimental Web Platform Features' in chrome://flags aktiviert?");
            }
        }

        function stopScan() {
            if (scanResult) {
                scanResult.stop();
                log("Scan gestoppt.");
                document.getElementById('status').innerText = "Gestoppt.";
            }
        }

        function handlePacket(event) {
            // 1. Daten extrahieren
            const mac = event.device.id; // Vorsicht: Im Web ist das oft eine randomisierte ID vom Browser, nicht die echte MAC!
            const rssi = event.rssi;
            const manufacturerData = event.manufacturerData;
            const serviceUuids = event.uuids;

            // 2. FILTERN (Hier passiert die Magie)
            let isTarget = false;
            let payloadHex = "";

            // Check A: Manufacturer ID
            manufacturerData.forEach((value, key) => {
                if (key === TARGET_COMPANY_ID) {
                    isTarget = true;
                    // Bytes zu Hex konvertieren für Fingerprint
                    for (let i = 0; i < value.byteLength; i++) {
                        payloadHex += value.getUint8(i).toString(16).padStart(2, '0');
                    }
                }
            });

            // Check B: Service UUID (Der 1523er)
            if (serviceUuids.some(uuid => uuid.includes(SHORT_UUID))) {
                isTarget = true;
            }

            // Wenn es kein Ziel ist, ignorieren wir es sofort
            if (!isTarget) return;

            // 3. Gruppierung / Update
            // Da MAC rotiert, nutzen wir den Payload oder einfach "TARGET" als Key, 
            // wenn wir nur das nächste FTS suchen.
            // Hier gruppieren wir nach dem erkannten Hex-Payload (der statisch sein sollte)
            const ghostID = payloadHex || "UNKNOWN_PAYLOAD_TARGET"; 

            if (!ghosts[ghostID]) {
                ghosts[ghostID] = { rssi: -100, count: 0, lastSeen: Date.now() };
                createDeviceUI(ghostID, payloadHex);
            }

            ghosts[ghostID].rssi = rssi;
            ghosts[ghostID].count++;
            ghosts[ghostID].lastSeen = Date.now();

            updateDeviceUI(ghostID, rssi, payloadHex, mac);
        }

        function createDeviceUI(id, payload) {
            const div = document.createElement('div');
            div.className = 'device';
            div.id = 'ui-' + id;
            div.innerHTML = `
                <div><strong>FTS SIGNAL ERKANNT</strong></div>
                <div style="font-size:0.8em; color:#aaa">Payload Fingerprint: ${payload.substring(0, 20)}...</div>
                <div class="mac-display">Letzte MAC: ...</div>
                <div class="rssi-text">RSSI: -- dBm</div>
                <div class="rssi-bar"><div class="rssi-val" style="width: 0%"></div></div>
            `;
            document.getElementById('results').prepend(div);
        }

        function updateDeviceUI(id, rssi, payload, mac) {
            const el = document.getElementById('ui-' + id);
            if (el) {
                // RSSI Visualisierung (Skala -100 bis -30)
                let percent = Math.max(0, Math.min(100, (rssi + 100) * 1.4));
                
                el.querySelector('.rssi-val').style.width = percent + '%';
                el.querySelector('.rssi-text').innerText = `RSSI: ${rssi} dBm (Pakete: ${ghosts[id].count})`;
                el.querySelector('.mac-display').innerText = `MAC (Browser ID): ${mac}`; // Achtung: Browser obfuscated MACs!
                
                // Visuelles Feedback bei sehr nahem Signal
                if (rssi > -60) {
                    el.style.borderColor = "#ff00ff"; // Pink bei Nähe
                    el.style.backgroundColor = "#2a002a";
                } else {
                    el.style.borderColor = "#333";
                    el.style.backgroundColor = "#1a1a1a";
                }
            }
        }
    </script>
</body>
</html>
 
