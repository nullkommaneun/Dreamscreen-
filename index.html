<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0e14">
    <title>BLE CMD - TARGET: YVES</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --c-bg:       #0a0e14;
            --c-surface:  #131920;
            --c-border:   #1e2a3a;
            --c-neon:     #00ff9f;
            --c-target:   #ff00ff;
            --c-blue:     #38bdf8;
            --c-amber:    #fbbf24;
            --c-red:      #f43f5e;
            --c-text:     #c8d6e5;
            --font-mono:  'JetBrains Mono', monospace;
            --font-ui:    'IBM Plex Sans', sans-serif;
            --radius:     8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { height: 100vh; background: var(--c-bg); color: var(--c-text); font-family: var(--font-ui); overflow: hidden; }
        #app { display: flex; flex-direction: column; height: 100dvh; }

        #topbar { padding: 12px 16px; background: var(--c-surface); border-bottom: 1px solid var(--c-border); display: flex; align-items: center; justify-content: space-between; }
        #topbar h1 { font-family: var(--font-mono); font-size: 14px; color: var(--c-neon); letter-spacing: 2px; }
        .status-pill { font-family: var(--font-mono); font-size: 10px; padding: 4px 10px; border-radius: 20px; background: #000; border: 1px solid var(--c-border); transition: all 0.3s; }
        .status-pill.scanning { color: var(--c-amber); border-color: var(--c-amber); animation: pulse 1s infinite; }
        .status-pill.target-found { color: var(--c-target); border-color: var(--c-target); animation: pulse 0.6s infinite; }
        .status-pill.connected { color: var(--c-neon); border-color: var(--c-neon); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

        #scan-stats { font-family: var(--font-mono); font-size: 10px; color: #5a6e82; padding: 6px 0; display: flex; justify-content: space-between; }
        #scan-stats .hl { color: var(--c-neon); }
        #scan-stats .tgt { color: var(--c-target); }

        #content { flex: 1; overflow-y: auto; padding: 12px 16px; -webkit-overflow-scrolling: touch; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .action-btn { width: 100%; padding: 14px; border: 1px solid var(--c-neon); border-radius: var(--radius); background: rgba(0,255,159,0.05); color: var(--c-neon); font-family: var(--font-mono); font-size: 12px; text-transform: uppercase; cursor: pointer; margin-bottom: 10px; -webkit-tap-highlight-color: transparent; }
        .action-btn:active { background: rgba(0,255,159,0.15); }
        .action-btn.stop { border-color: var(--c-red); color: var(--c-red); background: rgba(244,63,94,0.05); }
        .action-btn.blue { border-color: var(--c-blue); color: var(--c-blue); background: rgba(56,189,248,0.05); }
        .action-btn:disabled { opacity: 0.3; pointer-events: none; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn-row .action-btn { margin-bottom: 0; font-size: 10px; padding: 10px 6px; }

        #device-container { display: flex; flex-direction: column; }

        .device-card { background: var(--c-surface); border: 1px solid var(--c-border); border-radius: var(--radius); padding: 12px; margin-bottom: 8px; position: relative; transition: all 0.3s; }
        .device-card.target-lock {
            order: -1;
            border: 2px solid var(--c-target);
            background: rgba(255,0,255,0.05);
            box-shadow: 0 0 20px rgba(255,0,255,0.15);
            cursor: pointer;
        }
        .device-card.target-lock:active { background: rgba(255,0,255,0.12); }
        .device-card.target-lock::before {
            content: "★ TARGET — TAP TO CONNECT";
            position: absolute; top: -9px; left: 10px;
            background: var(--c-target); color: #fff;
            font-size: 8px; padding: 2px 8px;
            font-family: var(--font-mono); font-weight: 800;
            border-radius: 4px;
        }
        .device-card.connected-card {
            border-color: var(--c-neon);
            box-shadow: 0 0 15px rgba(0,255,159,0.15);
        }
        .device-card.connected-card::before {
            content: "CONNECTED"; background: var(--c-neon); color: #000;
        }

        .dev-row { display: flex; justify-content: space-between; align-items: center; }
        .dev-name { font-family: var(--font-mono); font-weight: 600; color: #fff; font-size: 13px; }
        .dev-name.unnamed { color: #5a6e82; font-style: italic; }
        .dev-rssi { font-family: var(--font-mono); font-weight: 800; font-size: 14px; min-width: 60px; text-align: right; }
        .dev-meta { font-size: 9px; color: #5a6e82; font-family: var(--font-mono); line-height: 1.6; margin-top: 4px; }
        .dev-mfr { font-size: 9px; color: var(--c-amber); font-family: var(--font-mono); margin-top: 2px; }
        .dev-services { font-size: 9px; color: var(--c-blue); font-family: var(--font-mono); margin-top: 2px; }
        .rssi-bar { height: 3px; border-radius: 2px; margin-top: 6px; transition: width 0.5s; }
        .dev-seen { font-size: 8px; color: #3a4a5a; font-family: var(--font-mono); margin-top: 4px; }

        .gatt-service { border: 1px solid var(--c-border); border-radius: var(--radius); margin-bottom: 10px; background: #000; overflow: hidden; }
        .svc-header { padding: 8px 12px; font-size: 11px; color: var(--c-blue); background: #1a2230; font-family: var(--font-mono); word-break: break-all; }
        .char-node { padding: 8px 12px; border-top: 1px solid var(--c-border); font-size: 11px; font-family: var(--font-mono); }
        .char-props { font-size: 9px; color: var(--c-amber); margin-top: 2px; }
        .val-display { display: block; background: #0a0e14; padding: 6px; color: var(--c-neon); margin-top: 4px; border-radius: 4px; overflow-wrap: anywhere; font-size: 10px; line-height: 1.5; }
        .notify-badge { display: inline-block; font-size: 8px; background: var(--c-target); color: #fff; padding: 1px 4px; border-radius: 3px; margin-left: 4px; }

        .log-entry { font-family: var(--font-mono); font-size: 10px; border-bottom: 1px solid #1e2a3a; padding: 4px 0; line-height: 1.5; }
        .log-target { color: var(--c-target); font-weight: bold; }
        .log-error { color: var(--c-red); }
        .log-warn { color: var(--c-amber); }

        #navbar { display: grid; grid-template-columns: repeat(3, 1fr); background: var(--c-surface); border-top: 1px solid var(--c-border); padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { padding: 12px; border: none; background: transparent; color: #5a6e82; font-family: var(--font-mono); font-size: 10px; text-transform: uppercase; -webkit-tap-highlight-color: transparent; }
        .nav-btn.active { color: var(--c-neon); border-top: 2px solid var(--c-neon); }

        .info-box { font-family: var(--font-mono); font-size: 10px; color: #5a6e82; padding: 10px; border: 1px dashed var(--c-border); border-radius: var(--radius); margin-bottom: 12px; line-height: 1.8; }
        .info-box code { color: var(--c-amber); }

        .gatt-status { font-family: var(--font-mono); font-size: 11px; padding: 12px; border: 1px solid var(--c-border); border-radius: var(--radius); margin-bottom: 12px; background: var(--c-surface); line-height: 1.8; }
        .gatt-status .label { color: #5a6e82; }
        .gatt-status .value { color: #fff; }
        .gatt-status .value.tgt { color: var(--c-target); }
    </style>
</head>
<body>

<div id="app">
    <div id="topbar">
        <h1>BLE // YVES</h1>
        <div class="status-pill" id="status-pill">IDLE</div>
    </div>

    <div id="content">
        <!-- SCAN TAB -->
        <div class="tab-panel active" id="tab-scan">
            <div class="info-box" id="info-box">
                Passiver Scan via <code>requestLEScan()</code><br>
                Flag: <code>chrome://flags/#enable-experimental-web-platform-features</code><br>
                JBL-Geräte werden markiert — antippen zum Verbinden.
            </div>
            <button class="action-btn" id="btn-scan" onclick="App.startScan()">▶ Scan starten</button>
            <button class="action-btn stop" id="btn-stop" onclick="App.stopScan()" style="display:none">■ Scan stoppen</button>
            <div id="scan-stats" style="display:none">
                <span>Geräte: <span class="hl" id="stat-total">0</span></span>
                <span>Targets: <span class="tgt" id="stat-target">0</span></span>
                <span>Pakete: <span class="hl" id="stat-updates">0</span></span>
            </div>
            <div id="device-container"></div>
        </div>

        <!-- GATT TAB -->
        <div class="tab-panel" id="tab-gatt">
            <div class="gatt-status" id="gatt-status">
                <span class="label">Status:</span> <span class="value" id="gatt-state-text">Nicht verbunden</span><br>
                <span class="label">Gerät:</span> <span class="value" id="gatt-device-name">—</span>
            </div>
            <button class="action-btn stop" id="btn-disconnect" onclick="App.disconnect()" disabled>Disconnect</button>
            <div id="gatt-container"></div>
        </div>

        <!-- LOG TAB -->
        <div class="tab-panel" id="tab-log">
            <div class="btn-row">
                <button class="action-btn" onclick="App.exportLog()">Export</button>
                <button class="action-btn stop" onclick="App.clearLog()">Clear</button>
            </div>
            <div id="log-container"></div>
        </div>
    </div>

    <div id="navbar">
        <button class="nav-btn active" data-tab="tab-scan" onclick="App.switchTab(this)">Radar</button>
        <button class="nav-btn" data-tab="tab-gatt" onclick="App.switchTab(this)">GATT</button>
        <button class="nav-btn" data-tab="tab-log" onclick="App.switchTab(this)">Log</button>
    </div>
</div>

<script>
const App = (() => {

    const state = {
        devices: new Map(),
        scanHandle: null,
        scanning: false,
        gattServer: null,
        gattDevice: null,
        activeNotifies: [],
        logEntries: [],
        updateCount: 0,
        connectedDeviceId: null
    };

    // ── Known IDs ──
    const KNOWN_MFR = {
        0x0057: 'Harman (JBL)',
        0x004C: 'Apple',
        0x0006: 'Microsoft',
        0x000D: 'Texas Instruments',
        0x0059: 'Nordic Semi',
        0x00E0: 'Google',
        0x0075: 'Samsung',
        0x0003: 'IBM',
    };

    // Alle Services die wir lesen wollen — möglichst breit
    const OPTIONAL_SERVICES = [
        'generic_access',
        'generic_attribute',
        'device_information',
        'battery_service',
        'heart_rate',
        'tx_power',
        'immediate_alert',
        'link_loss',
        0xFE61,  // Harman/JBL
        0xFEA0,  // Google Fast Pair
        0xFE07,
        0xFE08,
        0xFE09,
        0xFEB2,
    ];

    const KNOWN_SERVICE_NAMES = {
        '00001800-0000-1000-8000-00805f9b34fb': 'Generic Access',
        '00001801-0000-1000-8000-00805f9b34fb': 'Generic Attribute',
        '0000180a-0000-1000-8000-00805f9b34fb': 'Device Information',
        '0000180f-0000-1000-8000-00805f9b34fb': 'Battery Service',
        '00001804-0000-1000-8000-00805f9b34fb': 'TX Power',
        '00001802-0000-1000-8000-00805f9b34fb': 'Immediate Alert',
        '00001803-0000-1000-8000-00805f9b34fb': 'Link Loss',
        '0000fe61-0000-1000-8000-00805f9b34fb': 'JBL Custom (FE61)',
        '0000fea0-0000-1000-8000-00805f9b34fb': 'Google Fast Pair',
    };

    const KNOWN_CHAR_NAMES = {
        '2a00': 'Device Name', '2a01': 'Appearance',
        '2a04': 'Conn. Params', '2a05': 'Service Changed',
        '2a19': 'Battery Level', '2a23': 'System ID',
        '2a24': 'Model Number', '2a25': 'Serial Number',
        '2a26': 'Firmware Rev', '2a27': 'Hardware Rev',
        '2a28': 'Software Rev', '2a29': 'Manufacturer',
        '2a50': 'PnP ID', '2a07': 'TX Power Level',
    };

    // ── Logging ──
    function log(msg, type = 'info') {
        const ts = new Date().toLocaleTimeString('de-DE');
        state.logEntries.push({ ts, msg, type });
        const el = document.createElement('div');
        el.className = `log-entry ${type === 'target' ? 'log-target' : type === 'error' ? 'log-error' : type === 'warn' ? 'log-warn' : ''}`;
        el.textContent = `[${ts}] ${msg}`;
        document.getElementById('log-container').prepend(el);
    }

    // ── Tabs ──
    function switchTab(btn) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
        btn.classList.add('active');
    }

    function activateTab(tabId) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    }

    // ── Target Detection ──
    function isTargetDevice(name, mfrIds = []) {
        const n = (name || '').toLowerCase();
        if (n.includes('yves') || n.includes('jbl')) return true;
        if (mfrIds.includes(0x0057)) return true;
        return false;
    }

    // ── RSSI Helpers ──
    function rssiToPercent(rssi) {
        return Math.max(0, Math.min(100, (rssi + 100) / 70 * 100));
    }
    function rssiColor(rssi) {
        if (rssi > -50) return '#00ff9f';
        if (rssi > -70) return '#fbbf24';
        if (rssi > -85) return '#f97316';
        return '#f43f5e';
    }

    // ═══════════════════════════════════════
    //  PASSIVE SCAN
    // ═══════════════════════════════════════
    async function startScan() {
        if (!navigator.bluetooth) return alert('Web Bluetooth nicht verfügbar.');
        if (!navigator.bluetooth.requestLEScan) {
            return alert('requestLEScan() nicht verfügbar!\n\nAktiviere:\nchrome://flags/#enable-experimental-web-platform-features\n\nDann Chrome neu starten.');
        }

        try {
            log('Starte passiven BLE-Scan…');
            state.scanHandle = await navigator.bluetooth.requestLEScan({
                acceptAllAdvertisements: true
            });
            state.scanning = true;
            updateScanUI(true);
            log('Scan aktiv — Advertisements werden empfangen.', 'target');
            navigator.bluetooth.addEventListener('advertisementreceived', onAdvertisement);
        } catch (e) {
            log(`Scan-Fehler: ${e.message}`, 'error');
        }
    }

    function stopScan() {
        if (state.scanHandle) {
            state.scanHandle.stop();
            state.scanHandle = null;
        }
        state.scanning = false;
        navigator.bluetooth.removeEventListener('advertisementreceived', onAdvertisement);
        updateScanUI(false);
        log('Scan gestoppt.');
    }

    function updateScanUI(scanning) {
        document.getElementById('btn-scan').style.display = scanning ? 'none' : 'block';
        document.getElementById('btn-stop').style.display = scanning ? 'block' : 'none';
        document.getElementById('scan-stats').style.display = scanning ? 'flex' : 'none';
        document.getElementById('info-box').style.display = scanning ? 'none' : 'block';
        updatePill();
    }

    function updatePill() {
        const pill = document.getElementById('status-pill');
        if (state.gattServer && state.gattServer.connected) {
            pill.textContent = 'CONNECTED';
            pill.className = 'status-pill connected';
        } else if (state.scanning) {
            // Check if any target found
            let hasTarget = false;
            state.devices.forEach(d => { if (d.isTarget) hasTarget = true; });
            if (hasTarget) {
                pill.textContent = 'TARGET';
                pill.className = 'status-pill target-found';
            } else {
                pill.textContent = 'SCANNING';
                pill.className = 'status-pill scanning';
            }
        } else {
            pill.textContent = 'IDLE';
            pill.className = 'status-pill';
        }
    }

    // ═══════════════════════════════════════
    //  ADVERTISEMENT HANDLER
    // ═══════════════════════════════════════
    function onAdvertisement(event) {
        state.updateCount++;
        const device = event.device;
        const id = device.id;
        const name = device.name || event.name || null;
        const rssi = event.rssi;
        const txPower = event.txPower;

        // Manufacturer Data
        const mfrEntries = [];
        const mfrIds = [];
        if (event.manufacturerData) {
            event.manufacturerData.forEach((dv, companyId) => {
                mfrIds.push(companyId);
                const bytes = safeBytes(dv);
                const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
                mfrEntries.push({ companyId, name: KNOWN_MFR[companyId] || `0x${companyId.toString(16).padStart(4,'0')}`, hex });
            });
        }

        // Service UUIDs
        const serviceUUIDs = [];
        if (event.uuids) event.uuids.forEach(u => serviceUUIDs.push(u));

        // Service Data
        const serviceDataEntries = [];
        if (event.serviceData) {
            event.serviceData.forEach((dv, uuid) => {
                const bytes = safeBytes(dv);
                serviceDataEntries.push({ uuid, hex: Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join(' ') });
            });
        }

        const target = isTargetDevice(name, mfrIds);
        const existing = state.devices.get(id);

        state.devices.set(id, {
            device, name: name || (existing ? existing.name : null),
            rssi, txPower, mfrData: mfrEntries,
            serviceUUIDs, serviceData: serviceDataEntries,
            isTarget: target || (existing ? existing.isTarget : false),
            lastSeen: Date.now(),
            seenCount: existing ? existing.seenCount + 1 : 1
        });

        // Erste Target-Erkennung
        if (target && (!existing || !existing.isTarget)) {
            log(`★ TARGET: "${name}" RSSI: ${rssi}dBm`, 'target');
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            updatePill();
        }

        renderDeviceCard(id);
        document.getElementById('stat-total').textContent = state.devices.size;
        document.getElementById('stat-updates').textContent = state.updateCount;
        let tc = 0; state.devices.forEach(d => { if (d.isTarget) tc++; });
        document.getElementById('stat-target').textContent = tc;
    }

    // ═══════════════════════════════════════
    //  DEVICE CARD
    // ═══════════════════════════════════════
    function renderDeviceCard(id) {
        const info = state.devices.get(id);
        let card = document.querySelector(`[data-dev-id="${id}"]`);

        if (!card) {
            card = document.createElement('div');
            card.dataset.devId = id;
            document.getElementById('device-container').appendChild(card);
        }

        const isConnected = state.connectedDeviceId === id;
        card.className = `device-card${info.isTarget ? ' target-lock' : ''}${isConnected ? ' connected-card' : ''}`;

        // Tap-Handler: Target-Geräte → direkt verbinden
        if (info.isTarget && !isConnected) {
            card.onclick = () => connectToDevice(id);
            card.style.cursor = 'pointer';
        } else {
            card.onclick = null;
            card.style.cursor = 'default';
        }

        const displayName = info.name || '(kein Name)';
        const pct = rssiToPercent(info.rssi);
        const color = rssiColor(info.rssi);

        let extras = '';
        if (info.mfrData.length > 0) {
            extras += info.mfrData.map(m => `<div class="dev-mfr">MFR: ${m.name} [${m.hex}]</div>`).join('');
        }
        if (info.serviceUUIDs.length > 0) {
            extras += `<div class="dev-services">SVC: ${info.serviceUUIDs.map(u => shortUUID(u)).join(', ')}</div>`;
        }
        if (info.serviceData && info.serviceData.length > 0) {
            extras += info.serviceData.map(s => `<div class="dev-services">SVC-DATA ${shortUUID(s.uuid)}: [${s.hex}]</div>`).join('');
        }

        card.innerHTML = `
            <div class="dev-row">
                <span class="dev-name${info.name ? '' : ' unnamed'}">${displayName}</span>
                <span class="dev-rssi" style="color:${color}">${info.rssi != null ? info.rssi + ' dBm' : '—'}</span>
            </div>
            <div class="rssi-bar" style="width:${pct}%; background:${color}"></div>
            <div class="dev-meta">ID: ${id.substring(0,20)}${info.txPower != null ? ' · TX:' + info.txPower : ''}</div>
            ${extras}
            <div class="dev-seen">×${info.seenCount} · ${new Date(info.lastSeen).toLocaleTimeString('de-DE')}</div>
        `;
    }

    // ═══════════════════════════════════════
    //  CONNECT FLOW (vom Scan-Tab direkt)
    // ═══════════════════════════════════════
    async function connectToDevice(id) {
        const info = state.devices.get(id);
        if (!info) return;

        const name = info.name || 'Unbekannt';
        log(`Verbinde zu "${name}"…`);
        log('Chrome-Picker öffnet sich — bitte das Gerät bestätigen.', 'warn');

        // Scan pausieren für stabile Verbindung
        if (state.scanning) stopScan();

        try {
            // ── requestDevice mit möglichst losen Filtern ──
            // Wir bauen mehrere Filter-Optionen, damit Chrome
            // das Gerät sicher im Picker zeigt:
            const filters = [];

            // 1) Exakter Name (wenn bekannt)
            if (info.name) {
                filters.push({ name: info.name });
            }

            // 2) namePrefix-Varianten für JBL
            filters.push({ namePrefix: 'JBL' });
            filters.push({ namePrefix: 'jbl' });
            filters.push({ namePrefix: 'Jbl' });

            // 3) namePrefix für Yves-Varianten
            filters.push({ namePrefix: 'Yves' });
            filters.push({ namePrefix: 'YVES' });
            filters.push({ namePrefix: 'yves' });

            const pairedDevice = await navigator.bluetooth.requestDevice({
                filters,
                optionalServices: OPTIONAL_SERVICES
            });

            if (!pairedDevice.gatt) {
                log('GATT nicht verfügbar.', 'error');
                return;
            }

            // Disconnect-Handler
            pairedDevice.addEventListener('gattserverdisconnected', () => {
                log(`"${pairedDevice.name || name}" getrennt.`, 'error');
                state.gattServer = null;
                state.gattDevice = null;
                state.connectedDeviceId = null;
                state.activeNotifies = [];
                document.getElementById('btn-disconnect').disabled = true;
                document.getElementById('gatt-state-text').textContent = 'Getrennt';
                document.getElementById('gatt-state-text').className = 'value';
                renderDeviceCard(id);
                updatePill();
            });

            // GATT connect
            const server = await pairedDevice.gatt.connect();
            state.gattServer = server;
            state.gattDevice = pairedDevice;
            state.connectedDeviceId = id;

            const connectedName = pairedDevice.name || name;
            log(`GATT verbunden: "${connectedName}"`, 'target');

            // UI updaten
            document.getElementById('btn-disconnect').disabled = false;
            document.getElementById('gatt-state-text').textContent = 'Verbunden';
            document.getElementById('gatt-state-text').className = 'value tgt';
            document.getElementById('gatt-device-name').textContent = connectedName;
            updatePill();
            renderDeviceCard(id);

            // Automatisch zum GATT-Tab wechseln
            activateTab('tab-gatt');

            // Services auslesen
            await enumerateGATT(server);

        } catch (e) {
            if (e.name === 'NotFoundError') {
                log('Kein Gerät im Picker ausgewählt.', 'warn');
            } else {
                log(`Connect-Fehler: ${e.message}`, 'error');
            }
        }
    }

    function disconnect() {
        state.activeNotifies.forEach(n => {
            try { n.char.stopNotifications(); } catch (_) {}
        });
        state.activeNotifies = [];

        if (state.gattServer && state.gattServer.connected) {
            state.gattServer.disconnect();
            log('Manuell getrennt.');
        }
        state.gattServer = null;
        state.gattDevice = null;

        const prevId = state.connectedDeviceId;
        state.connectedDeviceId = null;

        document.getElementById('btn-disconnect').disabled = true;
        document.getElementById('gatt-state-text').textContent = 'Nicht verbunden';
        document.getElementById('gatt-state-text').className = 'value';
        document.getElementById('gatt-device-name').textContent = '—';
        document.getElementById('gatt-container').innerHTML = '';

        if (prevId) renderDeviceCard(prevId);
        updatePill();
    }

    // ═══════════════════════════════════════
    //  GATT ENUMERATION
    // ═══════════════════════════════════════
    async function enumerateGATT(server) {
        const container = document.getElementById('gatt-container');
        container.innerHTML = '';

        let services;
        try {
            services = await server.getPrimaryServices();
            log(`${services.length} GATT-Service(s) gefunden.`);
        } catch (e) {
            log(`getPrimaryServices: ${e.message}`, 'error');
            return;
        }

        for (const svc of services) {
            const svcName = KNOWN_SERVICE_NAMES[svc.uuid] || shortUUID(svc.uuid);

            const sEl = document.createElement('div');
            sEl.className = 'gatt-service';
            sEl.innerHTML = `<div class="svc-header">⬡ ${svcName}<br><span style="color:#5a6e82;font-size:9px">${svc.uuid}</span></div>`;
            container.appendChild(sEl);
            log(`  Service: ${svcName}`);

            let chars;
            try { chars = await svc.getCharacteristics(); }
            catch (e) { log(`  Chars-Fehler ${svcName}: ${e.message}`, 'error'); continue; }

            for (const char of chars) {
                const charShort = char.uuid.substring(4, 8);
                const charName = KNOWN_CHAR_NAMES[charShort] || charShort.toUpperCase();
                const props = describeProps(char.properties);
                const valId = `val-${char.uuid.replace(/-/g, '')}`;

                let badges = '';
                if (char.properties.notify) badges += '<span class="notify-badge">NOTIFY</span>';
                if (char.properties.indicate) badges += '<span class="notify-badge">INDICATE</span>';

                const cEl = document.createElement('div');
                cEl.className = 'char-node';
                cEl.innerHTML = `
                    <strong>${charName}</strong> ${badges}
                    <div class="char-props">${props}</div>
                    <div class="char-props" style="color:#5a6e82">${char.uuid}</div>
                    <span class="val-display" id="${valId}">…</span>
                `;
                sEl.appendChild(cEl);

                if (char.properties.read) readChar(char, valId);
                if (char.properties.notify || char.properties.indicate) subscribeChar(char, valId, charName);
            }
        }
        log('GATT Enumeration komplett.', 'target');
    }

    async function readChar(char, valId) {
        try {
            const val = await char.readValue();
            showValue(val, valId);
            log(`    READ ${shortUUID(char.uuid)}: ${decodeSafe(val)}`);
        } catch (e) {
            const el = document.getElementById(valId);
            if (el) el.textContent = `ERR: ${e.message}`;
        }
    }

    async function subscribeChar(char, valId, charName) {
        try {
            char.addEventListener('characteristicvaluechanged', (ev) => {
                showValue(ev.target.value, valId);
                log(`  NOTIFY ${charName}: ${decodeSafe(ev.target.value)}`, 'target');
            });
            await char.startNotifications();
            state.activeNotifies.push({ char });
            log(`    ✓ Subscribed: ${charName}`, 'target');
        } catch (e) {
            log(`    Notify-Fehler ${charName}: ${e.message}`, 'error');
        }
    }

    // ═══════════════════════════════════════
    //  DATA HELPERS
    // ═══════════════════════════════════════
    function safeBytes(dv) {
        return new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
    }

    function showValue(dv, elId) {
        const el = document.getElementById(elId);
        if (!el) return;
        const bytes = safeBytes(dv);
        const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
        const text = tryDecode(bytes);

        if (bytes.length === 1) {
            el.textContent = `${bytes[0]} (0x${hex})`;
        } else if (text && /^[\x20-\x7E]+$/.test(text)) {
            el.textContent = `"${text}"  [${hex}]`;
        } else {
            el.textContent = `[${hex}]`;
        }
    }

    function decodeSafe(dv) {
        const bytes = safeBytes(dv);
        const hex = Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join(' ');
        const text = tryDecode(bytes);
        if (text && /^[\x20-\x7E]+$/.test(text)) return `"${text}" [${hex}]`;
        return `[${hex}]`;
    }

    function tryDecode(bytes) {
        try { return new TextDecoder('utf-8', { fatal: false }).decode(bytes); }
        catch (_) { return null; }
    }

    function shortUUID(uuid) {
        if (!uuid) return '?';
        if (typeof uuid === 'number') return '0x' + uuid.toString(16).toUpperCase().padStart(4, '0');
        const s = String(uuid);
        if (s.endsWith('-0000-1000-8000-00805f9b34fb')) return '0x' + s.substring(4, 8).toUpperCase();
        return s.substring(0, 8) + '…';
    }

    function describeProps(p) {
        const f = [];
        if (p.read) f.push('READ');
        if (p.write) f.push('WRITE');
        if (p.writeWithoutResponse) f.push('WRITE_NR');
        if (p.notify) f.push('NOTIFY');
        if (p.indicate) f.push('INDICATE');
        if (p.broadcast) f.push('BROADCAST');
        return f.join(' | ') || 'NONE';
    }

    // ═══════════════════════════════════════
    //  LOG EXPORT
    // ═══════════════════════════════════════
    function exportLog() {
        const text = state.logEntries.map(e => `[${e.ts}] [${e.type}] ${e.msg}`).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `YVES_BLE_${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
        log('Log exportiert.');
    }

    function clearLog() {
        state.logEntries = [];
        document.getElementById('log-container').innerHTML = '';
    }

    return { startScan, stopScan, connectToDevice, disconnect, switchTab, exportLog, clearLog };
})();
</script>
</body>
</html>
