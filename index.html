<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0e14">
    <title>BLE CMD - TARGET: YVES</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --c-bg:       #0a0e14;
            --c-surface:  #131920;
            --c-border:   #1e2a3a;
            --c-neon:     #00ff9f;
            --c-target:   #ff00ff; /* Yves Pink */
            --c-blue:     #38bdf8;
            --c-amber:    #fbbf24;
            --c-red:      #f43f5e;
            --c-text:     #c8d6e5;
            --font-mono:  'JetBrains Mono', monospace;
            --font-ui:    'IBM Plex Sans', sans-serif;
            --radius:     8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { height: 100vh; background: var(--c-bg); color: var(--c-text); font-family: var(--font-ui); overflow: hidden; }

        #app { display: flex; flex-direction: column; height: 100dvh; }

        /* Header */
        #topbar { padding: 12px 16px; background: var(--c-surface); border-bottom: 1px solid var(--c-border); display: flex; align-items: center; justify-content: space-between; }
        #topbar h1 { font-family: var(--font-mono); font-size: 14px; color: var(--c-neon); letter-spacing: 2px; }
        .status-pill { font-family: var(--font-mono); font-size: 10px; padding: 4px 10px; border-radius: 20px; background: #000; border: 1px solid var(--c-border); }
        .status-pill[data-state="connected"] { color: var(--c-neon); border-color: var(--c-neon); }
        .status-pill[data-state="target-found"] { color: var(--c-target); border-color: var(--c-target); animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Content */
        #content { flex-grow: 1; position: relative; overflow-y: auto; padding: 16px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Target Highlighting */
        #device-container { display: flex; flex-direction: column; }
        .device-card { background: var(--c-surface); border: 1px solid var(--c-border); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; cursor: pointer; position: relative; }
        
        /* Yves-Spezifischer Fokus */
        .device-card.target-lock { 
            order: -1; /* Schiebt Yves immer nach oben */
            border: 2px solid var(--c-target); 
            background: rgba(255, 0, 255, 0.05);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.2);
        }
        .device-card.target-lock::before { content: "TARGET DETECTED"; position: absolute; top: -10px; left: 10px; background: var(--c-target); color: #fff; font-size: 8px; padding: 2px 6px; font-family: var(--font-mono); font-weight: 800; border-radius: 4px; }

        .dev-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .dev-name { font-family: var(--font-mono); font-weight: 600; color: #fff; }
        .dev-rssi { font-family: var(--font-mono); font-weight: 800; }

        /* Buttons */
        .action-btn { width: 100%; padding: 14px; border: 1px solid var(--c-neon); border-radius: var(--radius); background: rgba(0,255,159,0.05); color: var(--c-neon); font-family: var(--font-mono); text-transform: uppercase; cursor: pointer; margin-bottom: 16px; }
        .action-btn.blue { border-color: var(--c-blue); color: var(--c-blue); background: rgba(56,189,248,0.05); }

        /* GATT List */
        .gatt-service { border: 1px solid var(--c-border); border-radius: var(--radius); margin-bottom: 10px; background: #000; }
        .svc-header { padding: 8px 12px; font-size: 11px; color: var(--c-blue); background: #1a2230; font-family: var(--font-mono); }
        .char-node { padding: 8px 12px; border-top: 1px solid var(--c-border); font-size: 11px; }
        .val-display { display: block; background: #000; padding: 4px; color: var(--c-neon); margin-top: 4px; border-radius: 4px; overflow-wrap: anywhere; }

        /* Bottom Nav */
        #navbar { display: grid; grid-template-columns: repeat(3, 1fr); background: var(--c-surface); border-top: 1px solid var(--c-border); padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { padding: 12px; border: none; background: transparent; color: #5a6e82; font-family: var(--font-mono); font-size: 10px; text-transform: uppercase; }
        .nav-btn.active { color: var(--c-neon); border-top: 2px solid var(--c-neon); }

        .log-entry { font-family: var(--font-mono); font-size: 10px; border-bottom: 1px solid #1e2a3a; padding: 4px 0; }
        .log-target { color: var(--c-target); font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div id="topbar">
        <h1>BLE CMD // YVES-SNIFFER</h1>
        <div class="status-pill" id="status-pill" data-state="idle">IDLE</div>
    </div>

    <div id="content">
        <div class="tab-panel active" id="tab-scan">
            <button class="action-btn" onclick="App.scan()">Start Radar Scan</button>
            <div id="device-container"></div>
        </div>

        <div class="tab-panel" id="tab-gatt">
            <button class="action-btn blue" onclick="App.connect()">Target Connect</button>
            <div id="gatt-container"></div>
        </div>

        <div class="tab-panel" id="tab-log">
            <button class="action-btn" onclick="App.exportLog()">Export Log</button>
            <div id="log-container"></div>
        </div>
    </div>

    <div id="navbar">
        <button class="nav-btn active" data-tab="tab-scan" onclick="App.switchTab(this)">Radar</button>
        <button class="nav-btn" data-tab="tab-gatt" onclick="App.switchTab(this)">GATT</button>
        <button class="nav-btn" data-tab="tab-log" onclick="App.switchTab(this)">Log</button>
    </div>
</div>

<script>
const App = (() => {
    const state = {
        devices: new Map(),
        connectedDevice: null,
        logEntries: [],
        targetsFound: 0
    };

    const KNOWN = {
        manufacturers: { 0x0057: 'JBL/HARMAN', 0x0003: 'JBL-CRASH (IBM-ID)' },
        chars: { '00002a25': 'Serial Number', '00002a29': 'Manufacturer', '00002a00': 'Device Name' }
    };

    function log(msg, isTarget = false) {
        const ts = new Date().toLocaleTimeString();
        state.logEntries.push({ ts, msg, isTarget });
        const el = document.createElement('div');
        el.className = `log-entry ${isTarget ? 'log-target' : ''}`;
        el.textContent = `[${ts}] ${msg}`;
        const container = document.getElementById('log-container');
        container.prepend(el);
    }

    function switchTab(btn) {
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
        btn.classList.add('active');
    }

    async function scan() {
        if (!navigator.bluetooth) return alert("Web Bluetooth nicht unterstützt.");
        
        try {
            log("Suche nach Geräten...");
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['device_information', 0xFE61]
            });
            addDevice(device, -50);
        } catch (e) { log("Scan Fehler: " + e.message); }
    }

    function addDevice(device, rssi, mfrData = []) {
        const id = device.id;
        const name = device.name || "Unbekannt";
        const isYves = name.toLowerCase().includes('yves') || mfrData.includes(3);

        if (isYves) {
            log(`ZIEL ERKANNT: ${name}`, true);
            document.getElementById('status-pill').dataset.state = "target-found";
        }

        state.devices.set(id, { device, name, rssi, isYves });
        renderCard(id);
    }

    function renderCard(id) {
        const info = state.devices.get(id);
        let card = document.querySelector(`[data-id="${id}"]`);
        
        if (!card) {
            card = document.createElement('div');
            card.dataset.id = id;
            card.onclick = () => connectTo(info.device);
            document.getElementById('device-container').appendChild(card);
        }

        card.className = `device-card ${info.isYves ? 'target-lock' : ''}`;
        card.innerHTML = `
            <div class="dev-header">
                <span class="dev-name">${info.name}</span>
                <span class="dev-rssi">${info.rssi} dBm</span>
            </div>
            <div style="font-size:9px; color:#5a6e82; font-family:var(--font-mono)">ID: ${id.substring(0,15)}</div>
        `;
    }

    async function connect() {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [
                    { namePrefix: 'JBL' },
                    { manufacturerData: [{ companyIdentifier: 0x0057 }] },
                    { manufacturerData: [{ companyIdentifier: 0x0003 }] }
                ],
                optionalServices: ['device_information', 0xFE61]
            });
            await connectTo(device);
        } catch (e) { log("Connect Fehler: " + e.message); }
    }

    async function connectTo(device) {
        log(`Verbinde zu ${device.name}...`);
        try {
            const server = await device.gatt.connect();
            log("GATT verbunden!", true);
            document.getElementById('status-pill').textContent = "CONNECTED";
            document.getElementById('status-pill').dataset.state = "connected";
            
            const services = await server.getPrimaryServices();
            const container = document.getElementById('gatt-container');
            container.innerHTML = '';

            for (const svc of services) {
                const sEl = document.createElement('div');
                sEl.className = 'gatt-service';
                sEl.innerHTML = `<div class="svc-header">SERVICE: ${svc.uuid}</div>`;
                container.appendChild(sEl);

                const chars = await svc.getCharacteristics();
                for (const char of chars) {
                    const cEl = document.createElement('div');
                    cEl.className = 'char-node';
                    const name = KNOWN.chars[char.uuid.substring(4,8)] || char.uuid.substring(4,8);
                    cEl.innerHTML = `CHAR: ${name} <span class="val-display" id="val-${char.uuid}">Lese...</span>`;
                    sEl.appendChild(cEl);

                    if (char.properties.read) {
                        try {
                            const val = await char.readValue();
                            const decoded = new TextDecoder().decode(val);
                            const hex = Array.from(new Uint8Array(val.buffer)).map(b => b.toString(16).padStart(2,'0')).join(' ');
                            document.getElementById(`val-${char.uuid}`).textContent = `"${decoded}" [HEX: ${hex}]`;
                        } catch (err) { document.getElementById(`val-${char.uuid}`).textContent = "N/A"; }
                    }
                }
            }
        } catch (e) { log("GATT Error: " + e.message); }
    }

    function exportLog() {
        const blob = new Blob([JSON.stringify(state.logEntries)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `YVES_DUMP_${Date.now()}.json`;
        a.click();
    }

    return { scan, connect, switchTab, exportLog };
})();
</script>
</body>
</html>
