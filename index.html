<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLE DIAGNOSTIC TOOL V2.0</title>
    <style>
        :root { --bg: #121212; --text: #00ff41; --warn: #ffcc00; --err: #ff3333; --panel: #1e1e1e; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Consolas', 'Monaco', monospace; margin: 0; padding: 0; overflow: hidden; font-size: 12px; }
        
        /* HEADER / CONTROLS */
        #hud { position: fixed; top: 0; left: 0; right: 0; height: 140px; background: var(--panel); border-bottom: 2px solid var(--text); z-index: 100; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        button { flex: 1; height: 45px; background: #000; border: 1px solid var(--text); color: var(--text); font-weight: bold; font-family: inherit; cursor: pointer; text-transform: uppercase; }
        button:active { background: var(--text); color: #000; }
        button#btnStop { border-color: var(--err); color: var(--err); }
        button#btnExport { border-color: var(--warn); color: var(--warn); }

        /* METRICS */
        #metrics { display: flex; justify-content: space-between; font-size: 14px; border-top: 1px solid #333; padding-top: 5px; }
        .metric { text-align: center; }
        .val { font-size: 18px; font-weight: bold; display: block; }
        
        /* LOGGING AREA */
        #terminal { position: fixed; top: 150px; bottom: 0; left: 0; right: 0; padding: 10px; overflow-y: auto; background: #000; }
        .log-entry { border-bottom: 1px solid #333; padding: 4px 0; word-break: break-all; }
        .meta { color: #666; font-size: 10px; display: inline-block; width: 130px; }
        .rssi { font-weight: bold; width: 40px; display: inline-block; text-align: right; margin-right: 10px; }
        .rssi.weak { color: #555; }
        .rssi.med { color: var(--warn); }
        .rssi.strong { color: var(--text); }
        
        /* HIGHLIGHTS */
        .target-harman { color: #ff00ff; border: 1px solid #ff00ff; background: #220022; }
        .target-apple { color: #555; opacity: 0.7; } /* Noise reduction visual */
        
        .payload { display: block; color: #888; font-size: 10px; margin-left: 140px; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="btn-group">
            <button id="btnScan" onclick="toggleScan()">SCAN START</button>
            <button id="btnStop" onclick="stopScan()" disabled>STOP</button>
        </div>
        <button id="btnExport" onclick="exportCSV()" style="width:100%; height:30px;">DUMP DOWNLOAD (CSV)</button>
        
        <div id="metrics">
            <div class="metric"><span class="val" id="cnt-pkg">0</span>PKTS</div>
            <div class="metric"><span class="val" id="cnt-dev">0</span>DEVS</div>
            <div class="metric"><span class="val" id="cnt-target">0</span>SUSPECTS</div>
        </div>
        <div id="status" style="margin-top:5px; text-align:center; color:#fff;">READY</div>
    </div>

    <div id="terminal">
        </div>

    <script>
        // CORE VARIABLES
        let scanHandle = null;
        let db = []; // The raw database
        let devicesFound = new Set();
        let suspectCount = 0;
        let isScanning = false;

        // UI REFERENCES
        const uiLog = document.getElementById('terminal');
        const uiPkg = document.getElementById('cnt-pkg');
        const uiDev = document.getElementById('cnt-dev');
        const uiSus = document.getElementById('cnt-target');
        const uiStatus = document.getElementById('status');

        // UTILS
        const buf2hex = buffer => Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('').toUpperCase();

        async function toggleScan() {
            if (isScanning) return;
            
            try {
                uiStatus.innerText = "REQUESTING RADIO...";
                // Request Bluetooth Scan with ALL advertisements enabled
                const scan = await navigator.bluetooth.requestLEScan({
                    acceptAllAdvertisements: true,
                    keepRepeatedDevices: true
                });

                scanHandle = scan;
                isScanning = true;
                
                document.getElementById('btnScan').disabled = true;
                document.getElementById('btnStop').disabled = false;
                uiStatus.innerText = "SCANNING... (WALK AROUND)";
                uiStatus.style.color = "#0f0";

                navigator.bluetooth.addEventListener('advertisementreceived', handlePacket);

            } catch (err) {
                uiStatus.innerText = "ERR: " + err.message;
                uiStatus.style.color = "red";
                alert("Scan failed. Ensure 'Experimental Web Platform features' is enabled in chrome://flags");
            }
        }

        function stopScan() {
            if (scanHandle) {
                scanHandle.stop();
                isScanning = false;
                document.getElementById('btnScan').disabled = false;
                document.getElementById('btnStop').disabled = true;
                uiStatus.innerText = "HALTED. DOWNLOAD DATA NOW.";
                uiStatus.style.color = "yellow";
            }
        }

        function handlePacket(event) {
            // 1. EXTRACT DATA
            const ts = new Date().toISOString();
            const rssi = event.rssi;
            const mac = event.device.id; // Browser obfuscated ID
            const name = event.device.name || "N/A";
            const txPower = event.txPower || -127;
            
            // Parse Manufacturer Data
            let manId = "N/A";
            let manDataHex = "";
            let fullPayload = "";

            event.manufacturerData.forEach((value, key) => {
                manId = key.toString(16).padStart(4, '0').toUpperCase(); // e.g., 004C
                manDataHex = buf2hex(value.buffer);
                fullPayload += `MID:${manId}|D:${manDataHex}; `;
            });

            // Parse Service Data
            event.serviceData.forEach((value, key) => {
                fullPayload += `SVC:${key}|D:${buf2hex(value.buffer)}; `;
            });
            
            // UUIDs
            const uuids = event.uuids ? event.uuids.join(',') : "";

            // 2. DETECT SUSPECTS (Logic from Python analysis)
            let isSuspect = false;
            let isApple = (manId === "004C");
            
            // Known Harman/JBL ID is 0057, previous scan showed 0003 (IBM) with 57 signature
            if (manId === "0003" || manId === "0057" || fullPayload.includes("0457")) {
                isSuspect = true;
                suspectCount++;
            }

            // 3. STORE TO DB
            db.push({
                ts, rssi, mac, name, manId, fullPayload, uuids, txPower
            });
            devicesFound.add(mac);

            // 4. UPDATE UI
            updateUI(rssi, mac, name, fullPayload, isSuspect, isApple);
        }

        function updateUI(rssi, mac, name, payload, isSuspect, isApple) {
            // Throttling: Render visuals efficiently
            uiPkg.innerText = db.length;
            uiDev.innerText = devicesFound.size;
            uiSus.innerText = suspectCount;

            // Only render visual log for suspects OR strong signals OR every 10th packet (noise reduction)
            const isRelevant = isSuspect || rssi > -70 || (db.length % 10 === 0);

            if (!isRelevant) return;

            // Maintain max lines
            if (uiLog.childElementCount > 60) uiLog.lastElementChild.remove();

            const row = document.createElement('div');
            row.className = 'log-entry';
            if (isSuspect) row.classList.add('target-harman');
            if (isApple && !isSuspect) row.classList.add('target-apple');

            let rssiClass = rssi > -60 ? 'strong' : (rssi > -80 ? 'med' : 'weak');

            row.innerHTML = `
                <span class="meta">${mac.substr(0,14)}..</span>
                <span class="rssi ${rssiClass}">${rssi}</span>
                <span style="color:#fff; font-weight:bold;">${name !== "N/A" ? name : ""}</span>
                <span class="payload">${payload || "EMPTY_PAYLOAD"}</span>
            `;

            uiLog.prepend(row);
        }

        function exportCSV() {
            if (db.length === 0) { alert("NO DATA TO EXPORT"); return; }

            const header = ["Timestamp", "RSSI", "MAC_ID", "Name", "ManID", "Payload_Hex", "UUIDs", "TxPower"];
            const rows = db.map(d => [
                d.ts,
                d.rssi,
                d.mac,
                `"${d.name}"`, // Quote names
                d.manId,
                d.fullPayload.replace(/,/g, "."), // Sanitize commas
                d.uuids,
                d.txPower
            ].join(","));

            const csvContent = [header.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `BLE_DUMP_${new Date().getTime()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
