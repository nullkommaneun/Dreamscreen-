<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamScreen BT Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; }
        .hex-font { font-family: 'Courier New', Courier, monospace; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center shadow-lg">
        <div>
            <h1 class="text-xl font-bold text-cyan-400">DreamScreen <span class="text-slate-400">///</span> REVERSE ENGINEER</h1>
            <p class="text-xs text-slate-500">Bluetooth LE Protocol Debugger</p>
        </div>
        <div class="flex gap-2">
            <button id="btnConnect" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold transition-colors">
                Verbinden (Alle anzeigen)
            </button>
            <button id="btnDisconnect" class="bg-red-900 hover:bg-red-700 text-gray-300 px-4 py-2 rounded font-bold hidden transition-colors">
                Trennen
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Controls Panel -->
        <div class="w-full md:w-1/2 p-4 overflow-y-auto border-r border-slate-700 bg-slate-900/50">
            
            <!-- Connection Status -->
            <div id="statusPanel" class="mb-6 p-3 bg-slate-800 rounded border border-slate-700">
                <div class="flex justify-between">
                    <span class="text-slate-400">Status:</span>
                    <span id="connectionStatus" class="text-red-400 font-bold">Getrennt</span>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-slate-400">Device:</span>
                    <span id="deviceName" class="text-slate-200">-</span>
                </div>
            </div>

            <!-- Settings -->
            <div class="mb-6">
                <h2 class="text-sm uppercase tracking-wider text-slate-500 mb-2 font-bold">Protokoll Einstellungen</h2>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Write Flag (Byte 3)</label>
                        <select id="flagSelect" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm">
                            <option value="0x01">0x01 (No Response - Silent)</option>
                            <option value="0x11">0x11 (Response Req - WLAN default)</option>
                            <option value="0x00">0x00 (No Flags)</option>
                            <option value="0x30">0x30 (Discovery Flag?)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Group ID (Byte 2)</label>
                        <input type="text" id="groupIdInput" value="00" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-sm hex-font uppercase" maxlength="2">
                    </div>
                </div>
            </div>

            <!-- Custom Command Builder -->
            <div class="mb-6 p-4 bg-slate-800 rounded border border-slate-600 shadow-inner">
                <h2 class="text-sm uppercase tracking-wider text-cyan-500 mb-3 font-bold">Custom Command Builder</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">CMD 1 (Category)</label>
                        <input type="text" id="cmd1Input" value="03" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-center font-mono text-lg uppercase focus:border-cyan-500 outline-none" maxlength="2">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">CMD 2 (Action)</label>
                        <input type="text" id="cmd2Input" value="05" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-center font-mono text-lg uppercase focus:border-cyan-500 outline-none" maxlength="2">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1">Payload (Hex Bytes, Space separated)</label>
                    <input type="text" id="payloadInput" value="FF 00 00" class="w-full bg-slate-900 border border-slate-600 rounded p-2 font-mono text-sm uppercase focus:border-cyan-500 outline-none" placeholder="z.B. FF 00 00">
                </div>

                <button id="btnSendCustom" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-3 rounded shadow mt-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    SENDEN (Auto CRC)
                </button>
            </div>

            <!-- Quick Actions (Macros) -->
            <div class="mb-6">
                <h2 class="text-sm uppercase tracking-wider text-slate-500 mb-2 font-bold">Hack Macros</h2>
                <div class="grid grid-cols-1 gap-2">
                    <button id="btnMacroDiscovery" class="bg-purple-900/50 hover:bg-purple-800 border border-purple-700 text-purple-200 py-2 px-3 rounded text-left text-sm flex justify-between items-center group">
                        <span>1. Discovery / Handshake</span>
                        <span class="text-xs font-mono opacity-50 group-hover:opacity-100">Cmd: 01 0A | Flag: 30</span>
                    </button>
                    <button id="btnMacroPing" class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded text-left text-sm flex justify-between items-center">
                        <span>2. Ping (Lebenszeichen)</span>
                        <span class="text-xs font-mono opacity-50">Cmd: 01 0B</span>
                    </button>
                    <button id="btnMacroAmbient" class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded text-left text-sm flex justify-between items-center">
                        <span>3. Force Ambient Mode</span>
                        <span class="text-xs font-mono opacity-50">Cmd: 03 01 -> 03</span>
                    </button>
                    <button id="btnMacroRed" class="bg-red-900/50 hover:bg-red-800 border border-red-700 text-red-200 py-2 px-3 rounded text-left text-sm flex justify-between items-center">
                        <span>4. Set Color RED</span>
                        <span class="text-xs font-mono opacity-50">Cmd: 03 05 -> FF0000</span>
                    </button>
                    <button id="btnMacroGreen" class="bg-green-900/50 hover:bg-green-800 border border-green-700 text-green-200 py-2 px-3 rounded text-left text-sm flex justify-between items-center">
                        <span>Set Color GREEN</span>
                        <span class="text-xs font-mono opacity-50">Cmd: 03 05 -> 00FF00</span>
                    </button>
                     <button id="btnMacroBlue" class="bg-blue-900/50 hover:bg-blue-800 border border-blue-700 text-blue-200 py-2 px-3 rounded text-left text-sm flex justify-between items-center">
                        <span>Set Color BLUE</span>
                        <span class="text-xs font-mono opacity-50">Cmd: 03 05 -> 0000FF</span>
                    </button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="mt-8 border-t border-red-900/50 pt-4">
                 <h2 class="text-xs uppercase tracking-wider text-red-600 mb-2 font-bold">Danger Zone</h2>
                 <button id="btnBootloader" class="w-full bg-transparent border border-red-800 text-red-500 hover:bg-red-900/20 py-2 px-3 rounded text-xs">
                    Enter Bootloader (Update Mode)
                 </button>
            </div>
        </div>

        <!-- Log Panel -->
        <div class="w-full md:w-1/2 bg-black flex flex-col border-l border-slate-700">
            <div class="bg-slate-800 p-2 text-xs text-slate-400 flex justify-between items-center border-b border-slate-700">
                <span>COMMUNICATION LOG</span>
                <button id="btnClearLog" class="text-slate-500 hover:text-white uppercase">Clear</button>
            </div>
            <div id="consoleLog" class="flex-1 p-4 overflow-y-auto font-mono text-xs space-y-2">
                <div class="text-slate-600 italic">Ready to connect... waiting for device.</div>
            </div>
            <!-- Packet Decoder Preview (Static for now, could be dynamic) -->
            <div class="p-2 bg-slate-900 border-t border-slate-800 text-xs text-slate-500">
                Packet Structure: <span class="text-orange-400">FC</span> [Len] [Grp] [Flag] [C1] [C2] [Payload...] [CRC]
            </div>
        </div>
    </main>

    <script>
        // --- CRC TABLE & LOGIC ---
        // Same table as in the C# code
        const CRC8_TABLE = [
            0x00, 0x07, 0x0E, 0x09, 0x1C, 0x1B, 0x12, 0x15, 0x38, 0x3F, 0x36, 0x31, 0x24, 0x23, 0x2A, 0x2D,
            0x70, 0x77, 0x7E, 0x79, 0x6C, 0x6B, 0x62, 0x65, 0x48, 0x4F, 0x46, 0x41, 0x54, 0x53, 0x5A, 0x5D,
            0xE0, 0xE7, 0xEE, 0xE9, 0xFC, 0xFB, 0xF2, 0xF5, 0xD8, 0xDF, 0xD6, 0xD1, 0xC4, 0xC3, 0xCA, 0xCD,
            0x90, 0x97, 0x9E, 0x99, 0x8C, 0x8B, 0x82, 0x85, 0xA8, 0xAF, 0xA6, 0xA1, 0xB4, 0xB3, 0xBA, 0xBD,
            0xC7, 0xC0, 0xC9, 0xCE, 0xDB, 0xDC, 0xD5, 0xD2, 0xFF, 0xF8, 0xF1, 0xF6, 0xE3, 0xE4, 0xED, 0xEA,
            0xB7, 0xB0, 0xB9, 0xBE, 0xAB, 0xAC, 0xA5, 0xA2, 0x8F, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9D, 0x9A,
            0x27, 0x20, 0x29, 0x2E, 0x3B, 0x3C, 0x35, 0x32, 0x1F, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0D, 0x0A,
            0x57, 0x50, 0x59, 0x5E, 0x4B, 0x4C, 0x45, 0x42, 0x6F, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7D, 0x7A,
            0x89, 0x8E, 0x87, 0x80, 0x95, 0x92, 0x9B, 0x9C, 0xB1, 0xB6, 0xBF, 0xB8, 0xAD, 0xAA, 0xA3, 0xA4,
            0xF9, 0xFE, 0xF7, 0xF0, 0xE5, 0xE2, 0xEB, 0xEC, 0xC1, 0xC6, 0xCF, 0xC8, 0xDD, 0xDA, 0xD3, 0xD4,
            0x69, 0x6E, 0x67, 0x60, 0x75, 0x72, 0x7B, 0x7C, 0x51, 0x56, 0x5F, 0x58, 0x4D, 0x4A, 0x43, 0x44,
            0x19, 0x1E, 0x17, 0x10, 0x05, 0x02, 0x0B, 0x0C, 0x21, 0x26, 0x2F, 0x28, 0x3D, 0x3A, 0x33, 0x34,
            0x4E, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5C, 0x5B, 0x76, 0x71, 0x78, 0x7F, 0x6A, 0x6D, 0x64, 0x63,
            0x3E, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2C, 0x2B, 0x06, 0x01, 0x08, 0x0F, 0x1A, 0x1D, 0x14, 0x13,
            0xAE, 0xA9, 0xA0, 0xA7, 0xB2, 0xB5, 0xBC, 0xBB, 0x96, 0x91, 0x98, 0x9F, 0x8A, 0x8D, 0x84, 0x83,
            0xDE, 0xD9, 0xD0, 0xD7, 0xC2, 0xC5, 0xCC, 0xCB, 0xE6, 0xE1, 0xE8, 0xEF, 0xFA, 0xFD, 0xF4, 0xF3
        ];

        function calculateCRC8(dataArray) {
            let crc = 0;
            // The logic from C#: length = (data[1] & 255) + 1
            // This means CRC covers Header + LengthByte + Group + Flag + Cmds + Payload
            // Basically everything EXCEPT the CRC byte itself.
            let length = dataArray[1] + 1;
            
            for (let i = 0; i < length; i++) {
                if (i >= dataArray.length) break;
                let byte = dataArray[i];
                let idx = (byte ^ crc) & 0xFF;
                crc = CRC8_TABLE[idx];
            }
            return crc;
        }

        // --- BLUETOOTH VARIABLES ---
        let device, server, service;
        let charWrite, charNotify;
        // NOTE: We use the Full 128-bit UUID here to be safe, but we scan for EVERYTHING.
        const SERVICE_UUID = "0000ff60-0000-1000-8000-00805f9b34fb";
        const CHAR_WRITE_UUID = 0xFF61; 
        const CHAR_NOTIFY_UUID = 0xFF62;

        // --- UI ELEMENTS ---
        const btnConnect = document.getElementById('btnConnect');
        const btnDisconnect = document.getElementById('btnDisconnect');
        const connectionStatus = document.getElementById('connectionStatus');
        const consoleLog = document.getElementById('consoleLog');
        
        // --- LOGGING ---
        function log(msg, type = 'info') {
            const el = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            el.className = 'font-mono break-all';
            
            if (type === 'tx') {
                el.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="text-cyan-400 font-bold">TX &gt;&gt;</span> <span class="text-cyan-200">${msg}</span>`;
            } else if (type === 'rx') {
                 el.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="text-green-400 font-bold">RX &lt;&lt;</span> <span class="text-green-200">${msg}</span>`;
            } else if (type === 'error') {
                el.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="text-red-500 font-bold">ERR:</span> <span class="text-red-300">${msg}</span>`;
            } else {
                el.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="text-slate-300">${msg}</span>`;
            }
            
            consoleLog.appendChild(el);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function toHexString(dataView) {
            let s = '';
            for (let i = 0; i < dataView.byteLength; i++) {
                s += ('0' + dataView.getUint8(i).toString(16).toUpperCase()).slice(-2) + ' ';
            }
            return s.trim();
        }

        // --- BLUETOOTH LOGIC ---

        btnConnect.addEventListener('click', async () => {
            try {
                // FIXED: Changed to acceptAllDevices because the device might not advertise 0xFF60
                log("Scanning for ALL devices...");
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, 
                    optionalServices: [0xFF60, SERVICE_UUID] // Must list services to access them later
                });

                document.getElementById('deviceName').textContent = device.name || "Unnamed Device";
                device.addEventListener('gattserverdisconnected', onDisconnected);

                log(`Connecting to GATT Server...`);
                server = await device.gatt.connect();

                log(`Getting Service 0xFF60...`);
                // Try getting service by short or long UUID
                try {
                    service = await server.getPrimaryService(0xFF60);
                } catch(e) {
                     log("Short UUID failed, trying long...");
                     service = await server.getPrimaryService(SERVICE_UUID);
                }

                log(`Getting Characteristics...`);
                charWrite = await service.getCharacteristic(0xFF61);
                charNotify = await service.getCharacteristic(0xFF62);

                log(`Starting Notifications on 0xFF62...`);
                await charNotify.startNotifications();
                charNotify.addEventListener('characteristicvaluechanged', handleNotifications);

                connectionStatus.textContent = "VERBUNDEN";
                connectionStatus.className = "text-green-400 font-bold";
                btnConnect.classList.add('hidden');
                btnDisconnect.classList.remove('hidden');
                enableControls(true);
                log("Connected! Ready to send commands.", "success");

            } catch (error) {
                log(error, 'error');
            }
        });

        function onDisconnected() {
            connectionStatus.textContent = "Getrennt";
            connectionStatus.className = "text-red-400 font-bold";
            btnConnect.classList.remove('hidden');
            btnDisconnect.classList.add('hidden');
            enableControls(false);
            log("Device disconnected.", "error");
        }

        btnDisconnect.addEventListener('click', () => {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        });

        function handleNotifications(event) {
            const value = event.target.value;
            log(toHexString(value), 'rx');
        }

        async function sendPacket(cmd1, cmd2, payloadBytes = []) {
            if (!device || !device.gatt.connected) {
                log("Not connected!", "error");
                return;
            }

            // 1. Build Packet
            // Structure: FC [Len] [Grp] [Flag] [C1] [C2] [Payload...] [CRC]
            
            const flag = parseInt(document.getElementById('flagSelect').value, 16);
            const grp = parseInt(document.getElementById('groupIdInput').value, 16);
            
            const len = payloadBytes.length + 5; 

            const packet = [0xFC, len, grp, flag, cmd1, cmd2, ...payloadBytes];
            
            // 2. Calculate CRC
            const crc = calculateCRC8(packet);
            packet.push(crc);

            const data = new Uint8Array(packet);
            
            // 3. Send
            log(toHexString(new DataView(data.buffer)), 'tx');
            try {
                await charWrite.writeValue(data);
            } catch (e) {
                log("Write Failed: " + e, 'error');
            }
        }

        // --- BUTTON ACTIONS ---

        function enableControls(enabled) {
            const btns = document.querySelectorAll('button:not(#btnConnect)');
            btns.forEach(b => b.disabled = !enabled);
        }
        enableControls(false); // Disable initally

        document.getElementById('btnSendCustom').addEventListener('click', () => {
            const c1 = parseInt(document.getElementById('cmd1Input').value, 16);
            const c2 = parseInt(document.getElementById('cmd2Input').value, 16);
            
            const payloadStr = document.getElementById('payloadInput').value.trim();
            let payload = [];
            if (payloadStr) {
                payload = payloadStr.split(/\s+/).map(h => parseInt(h, 16));
            }
            sendPacket(c1, c2, payload);
        });

        // MACROS
        
        // 1. Discovery: Cmd 01 0A, Flag 30 (Broadcast?), Grp FF
        document.getElementById('btnMacroDiscovery').addEventListener('click', () => {
            const oldFlag = document.getElementById('flagSelect').value;
            const oldGrp = document.getElementById('groupIdInput').value;
            
            document.getElementById('flagSelect').value = "0x30";
            document.getElementById('groupIdInput').value = "FF"; 
            
            sendPacket(0x01, 0x0A, []); 
            
            setTimeout(() => {
                document.getElementById('flagSelect').value = oldFlag;
                document.getElementById('groupIdInput').value = oldGrp;
            }, 500);
        });

        // 2. Ping: Cmd 01 0B
        document.getElementById('btnMacroPing').addEventListener('click', () => {
            sendPacket(0x01, 0x0B, []);
        });

        // 3. Ambient: Cmd 03 01 -> Payload 03
        document.getElementById('btnMacroAmbient').addEventListener('click', () => {
            sendPacket(0x03, 0x01, [0x03]);
        });

        // 4. Colors
        document.getElementById('btnMacroRed').addEventListener('click', () => {
            sendPacket(0x03, 0x05, [0xFF, 0x00, 0x00]);
        });
        document.getElementById('btnMacroGreen').addEventListener('click', () => {
            sendPacket(0x03, 0x05, [0x00, 0xFF, 0x00]);
        });
        document.getElementById('btnMacroBlue').addEventListener('click', () => {
            sendPacket(0x03, 0x05, [0x00, 0x00, 0xFF]);
        });

        // DANGER: Bootloader
        document.getElementById('btnBootloader').addEventListener('click', () => {
             if(confirm("ACHTUNG: Dies versetzt das Gerät in den Update-Modus. Es reagiert möglicherweise nicht mehr auf Lichtbefehle, bis es neu gestartet wird. Fortfahren?")) {
                 sendPacket(0x04, 0x01, [0x4B, 0x61]);
             }
        });

    </script>
</body>
</html>


 
