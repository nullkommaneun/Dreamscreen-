<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLE¬∑OSINT ¬∑ PASSIVE MASSEN√úBERWACHUNG</title>
    <style>
        /* ---------- GLEICHES DESIGN WIE ORIGINAL, LEICHT ANGEPASST ---------- */
        :root {
            --bg:#0b0f17; --s1:#121724; --s2:#1a1f2e; --card:#0e1422;
            --b1:#262e3f; --b2:#2f3a4f;
            --neon:#0ff; --tgt:#f0f; --blue:#3b82f6; --amber:#fbbf24;
            --red:#ef4444; --orange:#f97316; --cyan:#22d3ee; --lime:#a3e635;
            --txt:#e2e8f0; --dim:#6b7a8f; --dim2:#334155;
            --m:'JetBrains Mono',monospace; --u:'IBM Plex Sans',sans-serif;
            --r:8px;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--txt);font-family:var(--u)}
        #app{display:flex;flex-direction:column;height:100dvh}
        #top{padding:6px 12px;background:var(--s1);border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
        #top h1{font-family:var(--m);font-size:12px;color:var(--neon);letter-spacing:2px}
        .pill{font-family:var(--m);font-size:9px;font-weight:600;padding:4px 10px;border-radius:20px;background:rgba(255,255,255,.03);border:1px solid var(--b1);color:var(--dim);text-transform:uppercase;transition:.2s}
        .pill.scan{color:var(--cyan);border-color:var(--cyan);animation:pulse 1.2s infinite}
        .pill.idle{border-color:var(--dim);color:var(--dim)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

        #content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px}
        .tab{display:none}
        .tab.active{display:block}

        .btn{width:100%;padding:10px;border-radius:var(--r);font-family:var(--m);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;border:1px solid var(--neon);color:var(--neon);background:rgba(0,255,255,.05);cursor:pointer;transition:.15s}
        .btn:active{background:rgba(0,255,255,.15)}
        .btn.red{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.05)}
        .btn.amber{border-color:var(--amber);color:var(--amber);background:rgba(251,191,36,.05)}
        .btn.small{padding:5px;font-size:9px}
        .btn-group{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0}

        .stats{display:flex;flex-wrap:wrap;gap:4px 15px;font-family:var(--m);font-size:10px;color:var(--dim);padding:6px 0;border-bottom:1px solid var(--b1);margin-bottom:8px}
        .stats span .val{color:var(--txt);font-weight:600;margin-left:4px}

        .card{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:8px;margin-bottom:5px;position:relative}
        .card.new{animation:glow 1s ease-out}
        @keyframes glow{0%{border-color:var(--neon);box-shadow:0 0 15px var(--neon)}100%{border-color:var(--b1);box-shadow:none}}
        .card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:6px}
        .card-name{font-family:var(--m);font-weight:600;color:#fff;font-size:12px;word-break:break-word}
        .card-name.none{color:var(--dim);font-style:italic}
        .card-rssi{font-family:var(--m);font-size:15px;font-weight:800;white-space:nowrap}
        .card-rssi small{font-size:8px;font-weight:400;margin-left:2px}
        .sigbar{height:2px;border-radius:1px;margin:4px 0;transition:width .3s}
        .tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
        .tag{font-family:var(--m);font-size:8px;padding:2px 5px;border-radius:3px;background:rgba(255,255,255,.03);color:var(--dim);border:1px solid var(--b2)}
        .tag.mfr{color:var(--amber);border-color:var(--amber)}
        .tag.svc{color:var(--blue);border-color:var(--blue)}
        .tag.adv{color:var(--cyan);border-color:var(--cyan)}
        .fingerprint{font-family:var(--m);font-size:7px;color:var(--dim);margin-top:4px;word-break:break-all;opacity:.7}
        .expander{font-size:10px;color:var(--cyan);cursor:pointer;margin-left:auto;padding:2px 6px}
        .detail-view{display:none;margin-top:6px;border-top:1px dashed var(--b1);padding-top:5px;font-size:9px;line-height:1.6}
        .detail-row{display:flex;gap:8px;flex-wrap:wrap}
        .detail-label{color:var(--dim);width:100px;flex-shrink:0}
        .detail-value{color:var(--txt);word-break:break-word}
        .hexdump{font-family:var(--m);font-size:7px;color:var(--amber);background:rgba(0,0,0,.3);padding:3px;border-radius:3px;margin-top:2px}

        /* Virtuelle Liste ‚Äì nur Platzhalter */
        #device-list-container{position:relative;height:calc(100vh - 200px);overflow-y:auto}
        .list-placeholder{height:1px}

        /* Telemetrie / Diagramme (einfache Canvas) */
        .graph-card{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:8px;margin-bottom:8px}
        .graph-title{font-family:var(--m);font-size:9px;color:var(--dim);margin-bottom:4px}
        canvas{display:block;width:100%;height:60px;background:#000;border-radius:4px}

        /* Logging */
        .log-entry{font-family:var(--m);font-size:8px;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.02);color:var(--dim)}
        .log-entry.warn{color:var(--amber)}
        .log-entry.err{color:var(--red)}

        /* Footer-Navigation */
        #nav{display:grid;grid-template-columns:repeat(5,1fr);background:var(--s1);border-top:1px solid var(--b1);padding-bottom:env(safe-area-inset-bottom)}
        .nb{padding:8px 2px;border:none;background:transparent;color:var(--dim);font-family:var(--m);font-size:9px;font-weight:600;text-transform:uppercase;border-top:2px solid transparent;transition:.2s}
        .nb.active{color:var(--neon);border-top-color:var(--neon)}

        /* Checkboxen / Filter */
        .filter-panel{background:var(--s2);border-radius:var(--r);padding:8px;margin-bottom:8px;font-size:10px}
        .filter-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    </style>
</head>
<body>
<div id="app">
    <div id="top">
        <h1>BLE¬∑OSINT ¬∑ MASSENSCAN</h1>
        <div class="pill" id="status-pill">IDLE</div>
    </div>

    <div id="content">
        <!-- TAB 1: SCAN / DASHBOARD -->
        <div class="tab active" id="tab-dash">
            <div class="btn-group">
                <button class="btn" id="btn-start">‚ñ∂ START SCAN</button>
                <button class="btn red" id="btn-stop" disabled>‚èπ STOP SCAN</button>
            </div>
            <div class="stats" id="live-stats">
                <span>Ger√§te (gesamt): <span class="val" id="stat-total">0</span></span>
                <span>aktiv (10s): <span class="val" id="stat-active">0</span></span>
                <span>Pakete: <span class="val" id="stat-packets">0</span></span>
                <span>Rate: <span class="val" id="stat-rate">0</span>/s</span>
            </div>

            <!-- Filterzeile (schnell) -->
            <div class="filter-panel">
                <div class="filter-row">
                    <span>üîç RSSI ‚â• <input type="number" id="filter-rssi" value="-100" step="5" style="width:60px;background:var(--s1);border:1px solid var(--b1);color:var(--txt);padding:2px"> dBm</span>
                    <label><input type="checkbox" id="filter-named" checked> nur mit Namen</label>
                    <label><input type="checkbox" id="filter-connectable" checked> connectable</label>
                    <span>Hersteller: <input type="text" id="filter-mfr" placeholder="z.B. 0x0057" style="width:80px"></span>
                </div>
            </div>

            <!-- Virtuelle Liste der Ger√§te -->
            <div id="device-list-container">
                <div id="device-list"></div>
                <div class="list-placeholder" id="list-placeholder"></div>
            </div>
        </div>

        <!-- TAB 2: ANALYSE (Fingerprints, Graphen) -->
        <div class="tab" id="tab-analysis">
            <h3 style="font-family:var(--m);color:var(--cyan);margin-bottom:6px">üìä SELEKTIERTES GER√ÑT</h3>
            <div id="selected-device-info" style="background:var(--s2);padding:8px;border-radius:var(--r);margin-bottom:10px">
                Kein Ger√§t ausgew√§hlt ‚Äì klicke in der Liste auf ein Ger√§t.
            </div>
            <div class="graph-card">
                <div class="graph-title">RSSI-Verlauf (letzte 60s)</div>
                <canvas id="rssi-canvas" width="400" height="60"></canvas>
            </div>
            <div class="graph-card">
                <div class="graph-title">ADV-Intervall / Jitter</div>
                <canvas id="adv-canvas" width="400" height="60"></canvas>
            </div>
            <div class="btn-group">
                <button class="btn small" id="btn-export-selected">üìÑ Exportiere als JSON</button>
                <button class="btn small amber" id="btn-forget-selected">üóë Vergessen</button>
            </div>
        </div>

        <!-- TAB 3: DATENBANK (IndexedDB-Ansicht) -->
        <div class="tab" id="tab-db">
            <div class="btn-group">
                <button class="btn" id="btn-export-all">üì¶ Export ALLE Ger√§te (CSV)</button>
                <button class="btn red" id="btn-clear-db">‚ö†Ô∏è DB leeren</button>
            </div>
            <div class="stats">
                <span>Gespeicherte Ger√§te: <span class="val" id="db-count">0</span></span>
                <span>letzter Export: <span class="val" id="db-last">‚Äî</span></span>
            </div>
            <div style="font-size:10px;color:var(--dim);margin:6px 0">
                Die Datenbank enth√§lt alle jemals gesehenen Advertisements. Du kannst nach Zeit, Hersteller, Service etc. filtern.
            </div>
            <input type="text" placeholder="UUID / Hersteller / Name suchen..." style="width:100%;background:var(--s1);border:1px solid var(--b1);color:var(--txt);padding:6px;border-radius:var(--r);margin-bottom:6px">
            <div id="db-list" style="max-height:300px;overflow-y:auto"></div>
        </div>

        <!-- TAB 4: HEATMAP (nur Platzhalter, da Geo nicht immer verf√ºgbar) -->
        <div class="tab" id="tab-heat">
            <p style="color:var(--dim);font-size:10px">üåç Heatmap (sofern Geo-Daten aktiviert)</p>
            <canvas id="heatmap-canvas" width="400" height="300" style="background:#111;border-radius:var(--r);width:100%;height:auto"></canvas>
            <div class="btn-group" style="margin-top:8px">
                <button class="btn small" id="btn-toggle-geo">üìç Geo-Tracking aktivieren</button>
                <button class="btn small amber" id="btn-export-kml">üìå Export KML</button>
            </div>
        </div>

        <!-- TAB 5: LOG / DEBUG -->
        <div class="tab" id="tab-log">
            <div class="btn-group">
                <button class="btn small" id="btn-export-log">üìã Log exportieren</button>
                <button class="btn small red" id="btn-clear-log">üóë Clear</button>
            </div>
            <div id="log-container" style="font-family:var(--m);font-size:8px;height:300px;overflow-y:auto;background:#000;padding:4px"></div>
        </div>
    </div>

    <!-- Navigation -->
    <div id="nav">
        <button class="nb active" data-tab="tab-dash">üì° Live</button>
        <button class="nb" data-tab="tab-analysis">üìà Analyse</button>
        <button class="nb" data-tab="tab-db">üóÉÔ∏è DB</button>
        <button class="nb" data-tab="tab-heat">üî• Heat</button>
        <button class="nb" data-tab="tab-log">üìú Log</button>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ------------------------------------------------------------
    //  KONFIGURATION & GLOBALE ZUST√ÑNDE
    // ------------------------------------------------------------
    const CONFIG = {
        DB_NAME: 'BLE_OSINT',
        DB_VERSION: 1,
        STALE_TIMEOUT: 10000,        // Ger√§t gilt als inaktiv nach 10s ohne Advertisement
        MAX_DEVICES_IN_MEMORY: 500,   // UI zeigt maximal 500 aktive Ger√§te (die frischesten)
        RSSI_HISTORY_LENGTH: 60,      // letzte 60 Werte pro Ger√§t (bei 1 Hz = 1 Minute)
        SCAN_INTERVAL_RATE: 1000,     // Berechnung der Paketrate
    };

    const STATE = {
        scanning: false,
        scanObject: null,
        totalPackets: 0,
        packetWindow: 0,
        packetRate: 0,

        // In-Memory-Cache der aktuell aktiven Ger√§te (f√ºr UI)
        devices: new Map(),           // deviceId -> Device-Objekt (mit History)

        // IndexedDB-Referenz
        db: null,

        // Geo-Tracking
        geoWatchId: null,
        lastPosition: null,
        geoEnabled: false,

        // Ausgew√§hltes Ger√§t f√ºr Analyse-Tab
        selectedDeviceId: null,

        // Filter
        filters: {
            rssiMin: -100,
            onlyNamed: true,
            connectable: true,
            manufacturer: '',
        },

        // Timers
        timers: {},
    };

    // ------------------------------------------------------------
    //  HILFSFUNKTIONEN (Log, Zeitstempel, Hex, etc.)
    // ------------------------------------------------------------
    function log(msg, level = 'info') {
        const ts = new Date().toLocaleTimeString('de-DE', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }) + '.' + String(new Date().getMilliseconds()).padStart(3, '0');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        if (level === 'warn') entry.classList.add('warn');
        if (level === 'err') entry.classList.add('err');
        entry.textContent = `[${ts}] ${msg}`;
        const container = document.getElementById('log-container');
        container.prepend(entry);
        while (container.children.length > 500) container.removeChild(container.lastChild);
    }

    function formatHex(bytes) {
        return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
    }

    function decodeUtf8(bytes) {
        try {
            return new TextDecoder('utf-8', { fatal: false }).decode(bytes);
        } catch {
            return null;
        }
    }

    // Sicherer Zugriff auf DataView -> Uint8Array
    function safeArray(buffer) {
        return new Uint8Array(buffer.buffer, buffer.byteOffset, buffer.byteLength);
    }

    // Kurzform f√ºr UUID (z.B. 0000xxxx-... -> xxxx)
    function shortUuid(uuid) {
        if (!uuid) return '?';
        const s = String(uuid).toLowerCase();
        if (s.endsWith('-0000-1000-8000-00805f9b34fb')) {
            return '0x' + s.substring(4, 8).toUpperCase();
        }
        return s.substring(0, 8) + '‚Ä¶';
    }

    // Bekannte Hersteller-IDs (aus der Bluetooth SIG)
    const MANUFACTURERS = {
        0x004C: 'Apple',
        0x0057: 'Harman/JBL',
        0x0006: 'Microsoft',
        0x00E0: 'Google',
        0x0075: 'Samsung',
        0x0059: 'Nordic',
        0x000D: 'Texas Instruments',
        0x001D: 'Qualcomm',
        0x0046: 'MediaTek',
        0x0087: 'Garmin',
        0x02FF: 'Xiaomi',
        0x0310: 'Xiaomi',
        0x0003: 'IBM',
        0x000F: 'Broadcom',
        0x001A: 'CSR',
        0x001B: 'Ericsson',
    };

    // Bekannte Service-UUIDs (nur eine kleine Auswahl)
    const SERVICE_NAMES = {
        '00001800': 'Generic Access',
        '00001801': 'Generic Attribute',
        '0000180A': 'Device Information',
        '0000180F': 'Battery',
        '00001804': 'TX Power',
        '00001802': 'Immediate Alert',
        '00001803': 'Link Loss',
        '00001812': 'HID',
        '0000FE61': 'JBL Proprietary',
        '0000FEA0': 'Google Fast Pair',
    };

    // ------------------------------------------------------------
    //  INDEXEDDB INITIALISIERUNG
    // ------------------------------------------------------------
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                STATE.db = request.result;
                log('IndexedDB ge√∂ffnet');
                updateDbCounter();
                resolve(request.result);
            };
            request.onupgradeneeded = (ev) => {
                const db = ev.target.result;
                // Object Store f√ºr Advertisements: jeder Eintrag = ein Advertisement-Paket
                if (!db.objectStoreNames.contains('advertisements')) {
                    const store = db.createObjectStore('advertisements', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('deviceId', 'deviceId', { unique: false });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('manufacturerId', 'manufacturerId', { unique: false });
                }
                // Object Store f√ºr Ger√§te-Zusammenfassungen (optional)
                if (!db.objectStoreNames.contains('devices')) {
                    const store = db.createObjectStore('devices', { keyPath: 'deviceId' });
                    store.createIndex('lastSeen', 'lastSeen', { unique: false });
                }
                log('DB-Upgrade durchgef√ºhrt', 'warn');
            };
        });
    }

    // Eintrag in IndexedDB speichern (Advertisement)
    function storeAdvertisement(deviceId, data) {
        if (!STATE.db) return;
        const tx = STATE.db.transaction(['advertisements'], 'readwrite');
        const store = tx.objectStore('advertisements');
        const record = {
            deviceId,
            timestamp: Date.now(),
            rssi: data.rssi,
            txPower: data.txPower,
            name: data.name,
            manufacturerData: data.manufacturerData ? Array.from(data.manufacturerData.entries()) : [],
            serviceUuids: data.serviceUuids ? Array.from(data.serviceUuids) : [],
            serviceData: data.serviceData ? Array.from(data.serviceData.entries()) : [],
            rawData: data.rawData ? Array.from(data.rawData) : null,
        };
        store.add(record);
        // F√ºr sp√§tere Analyse k√∂nnen wir auch das Ger√§t in devices updaten
        updateDeviceSummary(deviceId, data);
    }

    function updateDeviceSummary(deviceId, data) {
        if (!STATE.db) return;
        const tx = STATE.db.transaction(['devices'], 'readwrite');
        const store = tx.objectStore('devices');
        const getReq = store.get(deviceId);
        getReq.onsuccess = () => {
            let summary = getReq.result || { deviceId, firstSeen: Date.now(), lastSeen: Date.now(), appearances: 0 };
            summary.lastSeen = Date.now();
            summary.appearances++;
            if (data.name && !summary.bestName) summary.bestName = data.name;
            if (data.rssi !== undefined) summary.lastRssi = data.rssi;
            // Hersteller sammeln
            if (data.manufacturerData && data.manufacturerData.size) {
                summary.manufacturers = summary.manufacturers || [];
                for (let [id] of data.manufacturerData) {
                    if (!summary.manufacturers.includes(id)) summary.manufacturers.push(id);
                }
            }
            store.put(summary);
        };
    }

    function updateDbCounter() {
        if (!STATE.db) return;
        const tx = STATE.db.transaction(['devices'], 'readonly');
        const store = tx.objectStore('devices');
        const countReq = store.count();
        countReq.onsuccess = () => {
            document.getElementById('db-count').textContent = countReq.result;
        };
    }

    // ------------------------------------------------------------
    //  SCAN LOGIK (passiv)
    // ------------------------------------------------------------
    async function startScan() {
        if (!navigator.bluetooth) {
            alert('Web Bluetooth nicht verf√ºgbar.');
            return;
        }
        if (!navigator.bluetooth.requestLEScan) {
            alert('requestLEScan() fehlt.\nAktiviere chrome://flags/#enable-experimental-web-platform-features');
            return;
        }
        try {
            log('Starte passiven Scan (alle Advertisements)‚Ä¶', 'warn');
            STATE.scanObject = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
            STATE.scanning = true;
            navigator.bluetooth.addEventListener('advertisementreceived', onAdvertisement);
            // Paketraten-Timer
            STATE.timers.rate = setInterval(() => {
                STATE.packetRate = STATE.packetWindow;
                STATE.packetWindow = 0;
                document.getElementById('stat-rate').textContent = STATE.packetRate;
            }, CONFIG.SCAN_INTERVAL_RATE);
            // Stale-Markierung
            STATE.timers.stale = setInterval(markStale, 3000);
            updateUIForScan(true);
            log('Scan aktiv ‚Äì empfange Pakete‚Ä¶');
        } catch (e) {
            log('Scan-Fehler: ' + e.message, 'err');
        }
    }

    function stopScan() {
        if (STATE.scanObject) {
            STATE.scanObject.stop();
            STATE.scanObject = null;
        }
        STATE.scanning = false;
        navigator.bluetooth.removeEventListener('advertisementreceived', onAdvertisement);
        clearInterval(STATE.timers.rate);
        clearInterval(STATE.timers.stale);
        updateUIForScan(false);
        log('Scan gestoppt.');
    }

    function markStale() {
        const now = Date.now();
        let changed = false;
        STATE.devices.forEach((dev, id) => {
            const wasStale = dev.stale || false;
            dev.stale = (now - dev.lastSeen) > CONFIG.STALE_TIMEOUT;
            if (dev.stale !== wasStale) changed = true;
        });
        if (changed) applyFilterAndRender();
    }

    function updateUIForScan(active) {
        document.getElementById('btn-start').disabled = active;
        document.getElementById('btn-stop').disabled = !active;
        const pill = document.getElementById('status-pill');
        pill.className = active ? 'pill scan' : 'pill idle';
        pill.textContent = active ? 'SCANNING' : 'IDLE';
    }

    // ------------------------------------------------------------
    //  VERARBEITUNG EINES ADVERTISEMENTS
    // ------------------------------------------------------------
    function onAdvertisement(ev) {
        STATE.totalPackets++;
        STATE.packetWindow++;
        document.getElementById('stat-packets').textContent = STATE.totalPackets;

        const device = ev.device;
        const deviceId = device.id;
        const now = Date.now();

        // Bestehende Daten holen oder neu anlegen
        let dev = STATE.devices.get(deviceId);
        if (!dev) {
            dev = {
                deviceId,
                device,
                names: new Set(),
                bestName: null,
                rssiHistory: [],
                advTimestamps: [],
                manufacturerData: new Map(),
                serviceUuids: new Set(),
                serviceData: new Map(),
                txPower: null,
                firstSeen: now,
                lastSeen: now,
                count: 0,
                stale: false,
                connectable: device.gatt ? true : false, // grob: ob GATT verf√ºgbar
            };
            STATE.devices.set(deviceId, dev);
        }

        // Werte extrahieren
        if (ev.rssi !== undefined) {
            dev.rssiHistory.push({ t: now, rssi: ev.rssi });
            if (dev.rssiHistory.length > CONFIG.RSSI_HISTORY_LENGTH) dev.rssiHistory.shift();
        }
        if (ev.txPower !== undefined) dev.txPower = ev.txPower;

        // Name aus verschiedenen Quellen
        const nameCandidates = [device.name, ev.name];
        try { if (ev.localName) nameCandidates.push(ev.localName); } catch (_) {}
        for (let n of nameCandidates) {
            if (n && typeof n === 'string' && n.trim()) {
                dev.names.add(n.trim());
            }
        }
        // besten Namen ermitteln (l√§ngsten)
        dev.bestName = Array.from(dev.names).sort((a,b) => b.length - a.length)[0] || null;

        // Herstellerdaten
        if (ev.manufacturerData && ev.manufacturerData.size) {
            ev.manufacturerData.forEach((data, cid) => {
                dev.manufacturerData.set(cid, safeArray(data));
            });
        }

        // Service UUIDs
        if (ev.uuids) {
            ev.uuids.forEach(u => dev.serviceUuids.add(u));
        }

        // Service Data
        if (ev.serviceData && ev.serviceData.size) {
            ev.serviceData.forEach((data, uuid) => {
                dev.serviceData.set(uuid, safeArray(data));
            });
        }

        // Advertising-Timestamps f√ºr Intervallberechnung
        dev.advTimestamps.push(now);
        if (dev.advTimestamps.length > 50) dev.advTimestamps.shift();

        dev.lastSeen = now;
        dev.count++;

        // In IndexedDB speichern (asynchron)
        storeAdvertisement(deviceId, {
            rssi: ev.rssi,
            txPower: ev.txPower,
            name: dev.bestName,
            manufacturerData: dev.manufacturerData,
            serviceUuids: dev.serviceUuids,
            serviceData: dev.serviceData,
            rawData: ev.rawData ? safeArray(ev.rawData) : null,
        });

        // UI-Update nur, wenn das Ger√§t aktuell sichtbar sein k√∂nnte (nach Filter)
        applyFilterAndRenderThrottled(deviceId);
    }

    // ------------------------------------------------------------
    //  FILTER & RENDER (mit Throttling)
    // ------------------------------------------------------------
    let renderThrottle = {};
    function applyFilterAndRenderThrottled(deviceId) {
        if (renderThrottle[deviceId]) clearTimeout(renderThrottle[deviceId]);
        renderThrottle[deviceId] = setTimeout(() => {
            delete renderThrottle[deviceId];
            applyFilterAndRender();
        }, 200);
    }

    function applyFilterAndRender() {
        // Statistik-Total / Aktiv
        let activeCount = 0;
        STATE.devices.forEach(dev => { if (!dev.stale) activeCount++; });
        document.getElementById('stat-total').textContent = STATE.devices.size;
        document.getElementById('stat-active').textContent = activeCount;

        // Filter anwenden und Liste bef√ºllen (nur nicht-stale, nach Filter)
        const filter = STATE.filters;
        const devicesArray = Array.from(STATE.devices.values())
            .filter(dev => {
                if (dev.stale) return false;
                if (filter.rssiMin > -100) {
                    const lastRssi = dev.rssiHistory.length ? dev.rssiHistory[dev.rssiHistory.length-1].rssi : -100;
                    if (lastRssi < filter.rssiMin) return false;
                }
                if (filter.onlyNamed && !dev.bestName) return false;
                if (filter.connectable && !dev.connectable) return false;
                if (filter.manufacturer) {
                    const mfrHex = parseInt(filter.manufacturer, 16);
                    if (isNaN(mfrHex) || !dev.manufacturerData.has(mfrHex)) return false;
                }
                return true;
            })
            .sort((a,b) => b.lastSeen - a.lastSeen) // neueste zuerst
            .slice(0, CONFIG.MAX_DEVICES_IN_MEMORY); // UI-Begrenzung

        renderDeviceList(devicesArray);
    }

    function renderDeviceList(devices) {
        const container = document.getElementById('device-list');
        container.innerHTML = '';
        for (let dev of devices) {
            container.appendChild(createDeviceCard(dev));
        }
    }

    function createDeviceCard(dev) {
        const card = document.createElement('div');
        card.className = 'card' + (dev.count === 1 ? ' new' : '');
        card.dataset.deviceId = dev.deviceId;

        // RSSI-Farben
        const lastRssi = dev.rssiHistory.length ? dev.rssiHistory[dev.rssiHistory.length-1].rssi : null;
        const rssiColor = !lastRssi ? '#666' : lastRssi > -50 ? '#0ff' : lastRssi > -65 ? '#a3e635' : lastRssi > -75 ? '#fbbf24' : lastRssi > -85 ? '#f97316' : '#ef4444';
        const rssiPercent = lastRssi ? Math.min(100, Math.max(0, (lastRssi + 100) / 70 * 100)) : 0;

        // Header
        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
            <span class="card-name ${dev.bestName ? '' : 'none'}">${dev.bestName || '‚Äπunbekannt‚Ä∫'}</span>
            <span class="card-rssi" style="color:${rssiColor}">${lastRssi || '‚Äî'}<small> dBm</small></span>
        `;
        card.appendChild(header);

        // Signal-Balken
        const bar = document.createElement('div');
        bar.className = 'sigbar';
        bar.style.width = rssiPercent + '%';
        bar.style.background = rssiColor;
        card.appendChild(bar);

        // Tags
        const tags = document.createElement('div');
        tags.className = 'tags';

        // Hersteller-Tags
        dev.manufacturerData.forEach((data, cid) => {
            const mfrName = MANUFACTURERS[cid] || `0x${cid.toString(16).padStart(4,'0')}`;
            const tag = document.createElement('span');
            tag.className = 'tag mfr';
            tag.textContent = mfrName;
            tag.title = `Daten: ${formatHex(data)}`;
            tags.appendChild(tag);
        });

        // Service-Tags
        dev.serviceUuids.forEach(uuid => {
            const short = shortUuid(uuid);
            const name = SERVICE_NAMES[uuid.substring(0,8).toUpperCase()] || short;
            const tag = document.createElement('span');
            tag.className = 'tag svc';
            tag.textContent = name;
            tags.appendChild(tag);
        });

        // ADV-Intervall (falls berechenbar)
        if (dev.advTimestamps.length >= 3) {
            const intervals = [];
            for (let i=1; i<dev.advTimestamps.length; i++) {
                intervals.push(dev.advTimestamps[i] - dev.advTimestamps[i-1]);
            }
            const avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
            const jitter = Math.sqrt(intervals.map(v=>(v-avg)**2).reduce((a,b)=>a+b,0)/intervals.length);
            const tag = document.createElement('span');
            tag.className = 'tag adv';
            tag.textContent = `${Math.round(avg)}ms ¬±${Math.round(jitter)}ms`;
            tags.appendChild(tag);
        }

        card.appendChild(tags);

        // Fingerprint (kurz)
        const fp = document.createElement('div');
        fp.className = 'fingerprint';
        // Einfacher Fingerprint aus MAC-Adresse (deviceId) + Hersteller + Services
        const mfrList = Array.from(dev.manufacturerData.keys()).map(k=>'0x'+k.toString(16)).join(',');
        const svcList = Array.from(dev.serviceUuids).map(shortUuid).join(',');
        fp.textContent = `üÜî ${dev.deviceId.slice(0,8)}‚Ä¶ ¬∑ MFR: ${mfrList || '‚Äî'} ¬∑ SVC: ${svcList || '‚Äî'}`;
        card.appendChild(fp);

        // Expander f√ºr Details
        const expander = document.createElement('span');
        expander.className = 'expander';
        expander.textContent = '‚ñº Details';
        expander.onclick = (e) => {
            e.stopPropagation();
            const detail = card.querySelector('.detail-view');
            if (detail) {
                detail.style.display = detail.style.display === 'block' ? 'none' : 'block';
                expander.textContent = detail.style.display === 'block' ? '‚ñ≤ Details' : '‚ñº Details';
            }
        };
        card.appendChild(expander);

        // Detailansicht (zun√§chst versteckt)
        const detail = document.createElement('div');
        detail.className = 'detail-view';
        detail.innerHTML = `
            <div class="detail-row"><span class="detail-label">Device ID</span><span class="detail-value">${dev.deviceId}</span></div>
            <div class="detail-row"><span class="detail-label">Connectable</span><span class="detail-value">${dev.connectable ? 'ja' : 'nein'}</span></div>
            <div class="detail-row"><span class="detail-label">TX Power</span><span class="detail-value">${dev.txPower ?? '‚Äî'} dBm</span></div>
            <div class="detail-row"><span class="detail-label">Erst gesehen</span><span class="detail-value">${new Date(dev.firstSeen).toLocaleTimeString()}</span></div>
            <div class="detail-row"><span class="detail-label">Pakete</span><span class="detail-value">${dev.count}</span></div>
            <div class="detail-row"><span class="detail-label">Hersteller-Rohdaten</span><span class="detail-value hexdump">${Array.from(dev.manufacturerData.entries()).map(([cid,arr]) => `0x${cid.toString(16)}: ${formatHex(arr)}`).join('<br>') || '‚Äî'}</span></div>
            <div class="detail-row"><span class="detail-label">Service Data</span><span class="detail-value hexdump">${Array.from(dev.serviceData.entries()).map(([uuid,arr]) => `${shortUuid(uuid)}: ${formatHex(arr)}`).join('<br>') || '‚Äî'}</span></div>
        `;
        card.appendChild(detail);

        // Klick auf die ganze Karte w√§hlt das Ger√§t f√ºr Analyse aus
        card.addEventListener('click', (e) => {
            if (e.target.classList.contains('expander')) return;
            selectDevice(dev.deviceId);
        });

        return card;
    }

    // ------------------------------------------------------------
    //  AUSWAHL EINES GER√ÑTS (Analyse-Tab)
    // ------------------------------------------------------------
    function selectDevice(deviceId) {
        STATE.selectedDeviceId = deviceId;
        const dev = STATE.devices.get(deviceId);
        if (!dev) return;

        // Info im Analyse-Tab f√ºllen
        const infoDiv = document.getElementById('selected-device-info');
        infoDiv.innerHTML = `
            <div><strong>${dev.bestName || '‚Äπunbekannt‚Ä∫'}</strong> (${deviceId.slice(0,8)}‚Ä¶)</div>
            <div style="font-size:9px; margin-top:4px">Letzter RSSI: ${dev.rssiHistory.length ? dev.rssiHistory[dev.rssiHistory.length-1].rssi : '‚Äî'} dBm ¬∑ Pakete: ${dev.count}</div>
        `;

        // Graphen zeichnen
        drawRssiGraph(dev);
        drawAdvGraph(dev);

        // Tab wechseln? Optional, lassen wir manuell
    }

    function drawRssiGraph(dev) {
        const canvas = document.getElementById('rssi-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);
        if (!dev.rssiHistory.length) return;

        const history = dev.rssiHistory.slice(-30); // letzte 30 Werte
        const minRssi = -100, maxRssi = -30;
        ctx.strokeStyle = '#0ff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i=0; i<history.length; i++) {
            const x = (i / (history.length-1)) * w;
            const y = h - ((history[i].rssi - minRssi) / (maxRssi - minRssi)) * h;
            if (i===0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    function drawAdvGraph(dev) {
        const canvas = document.getElementById('adv-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);
        if (dev.advTimestamps.length < 3) return;

        const intervals = [];
        for (let i=1; i<dev.advTimestamps.length; i++) {
            intervals.push(dev.advTimestamps[i] - dev.advTimestamps[i-1]);
        }
        const maxInt = Math.max(...intervals, 200);
        ctx.strokeStyle = '#fbbf24';
        ctx.beginPath();
        for (let i=0; i<intervals.length; i++) {
            const x = (i / (intervals.length-1)) * w;
            const y = h - (intervals[i] / maxInt) * h;
            if (i===0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }

    // ------------------------------------------------------------
    //  EXPORT-FUNKTIONEN
    // ------------------------------------------------------------
    function exportAllAsCSV() {
        if (!STATE.db) return;
        const tx = STATE.db.transaction(['devices'], 'readonly');
        const store = tx.objectStore('devices');
        const req = store.getAll();
        req.onsuccess = () => {
            const devices = req.result;
            let csv = 'DeviceID,FirstSeen,LastSeen,BestName,LastRSSI,Manufacturers,Services\n';
            devices.forEach(d => {
                const line = [
                    d.deviceId,
                    new Date(d.firstSeen).toISOString(),
                    new Date(d.lastSeen).toISOString(),
                    d.bestName || '',
                    d.lastRssi || '',
                    (d.manufacturers || []).map(m => '0x'+m.toString(16)).join(';'),
                    ''
                ].map(s => `"${s}"`).join(',');
                csv += line + '\n';
            });
            download(csv, 'ble_osint_devices.csv', 'text/csv');
            log('CSV-Export gestartet.');
        };
    }

    function download(content, fileName, mime) {
        const blob = new Blob([content], { type: mime });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    // ------------------------------------------------------------
    //  GEO-TRACKING
    // ------------------------------------------------------------
    function toggleGeo() {
        if (STATE.geoEnabled) {
            if (STATE.geoWatchId !== null) {
                navigator.geolocation.clearWatch(STATE.geoWatchId);
                STATE.geoWatchId = null;
            }
            STATE.geoEnabled = false;
            log('Geo-Tracking deaktiviert');
            document.getElementById('btn-toggle-geo').textContent = 'üìç Geo-Tracking aktivieren';
        } else {
            if (!navigator.geolocation) {
                alert('Geolocation nicht verf√ºgbar');
                return;
            }
            STATE.geoWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    STATE.lastPosition = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        acc: pos.coords.accuracy,
                        ts: pos.timestamp
                    };
                    log(`Position: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`);
                },
                (err) => log('Geo-Fehler: ' + err.message, 'err'),
                { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
            );
            STATE.geoEnabled = true;
            document.getElementById('btn-toggle-geo').textContent = 'üìç Geo-Tracking deaktivieren';
            log('Geo-Tracking gestartet');
        }
    }

    // ------------------------------------------------------------
    //  TAB-NAVIGATION
    // ------------------------------------------------------------
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nb').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    }

    // ------------------------------------------------------------
    //  INITIALISIERUNG
    // ------------------------------------------------------------
    window.addEventListener('load', async () => {
        log('BLE OSINT Tool gestartet ‚Äì passiver Massenscan-Modus', 'warn');
        await initDB();

        // Event-Listener f√ºr Buttons
        document.getElementById('btn-start').addEventListener('click', startScan);
        document.getElementById('btn-stop').addEventListener('click', stopScan);
        document.getElementById('btn-export-all').addEventListener('click', exportAllAsCSV);
        document.getElementById('btn-toggle-geo').addEventListener('click', toggleGeo);
        document.getElementById('btn-clear-db').addEventListener('click', () => {
            if (confirm('Wirklich alle Daten l√∂schen?')) {
                // DB l√∂schen und neu initialisieren
                indexedDB.deleteDatabase(CONFIG.DB_NAME);
                setTimeout(() => initDB(), 100);
                log('DB wurde gel√∂scht', 'err');
            }
        });

        // Filter-Inputs
        document.getElementById('filter-rssi').addEventListener('input', (e) => {
            STATE.filters.rssiMin = parseInt(e.target.value) || -100;
            applyFilterAndRender();
        });
        document.getElementById('filter-named').addEventListener('change', (e) => {
            STATE.filters.onlyNamed = e.target.checked;
            applyFilterAndRender();
        });
        document.getElementById('filter-connectable').addEventListener('change', (e) => {
            STATE.filters.connectable = e.target.checked;
            applyFilterAndRender();
        });
        document.getElementById('filter-mfr').addEventListener('input', (e) => {
            STATE.filters.manufacturer = e.target.value.trim();
            applyFilterAndRender();
        });

        // Navigation
        document.querySelectorAll('.nb').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });
    });
})();
</script>
</body>
</html>
